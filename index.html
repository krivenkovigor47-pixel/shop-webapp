<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Saturn Shop</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{--bg:#1a1a2e;--text:#eaeaea;--hint:#8b8b9e;--accent:#6c63ff;--accent2:#5a52d5;--card:#1e2746;--border:#2a3a5c;--ok:#4caf50;--no:#f44336;--gold:#ffd700;--r:16px;--rs:10px;--sh:0 4px 15px rgba(0,0,0,.3);--bg2:#16213e}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;padding-bottom:80px}
.hd{background:linear-gradient(135deg,var(--accent),#4a3fcf);padding:20px 16px 16px;position:sticky;top:0;z-index:100;box-shadow:var(--sh)}
.ht{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px}
.sn{font-size:22px;font-weight:800}
.hi{display:flex;gap:12px}
.hib{width:40px;height:40px;border-radius:50%;background:rgba(255,255,255,.15);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:18px;transition:.2s;position:relative}
.hib:active{transform:scale(.9)}
.cb{position:absolute;top:-4px;right:-4px;background:var(--no);color:#fff;font-size:11px;font-weight:700;min-width:18px;height:18px;border-radius:9px;display:flex;align-items:center;justify-content:center;padding:0 4px}
.db{background:rgba(255,255,255,.12);border-radius:var(--rs);padding:10px 14px;display:flex;align-items:center;gap:10px;font-size:13px;cursor:pointer}
.db .e{font-size:20px}.db .t{flex:1}.db .p{font-size:20px;font-weight:800;color:var(--gold)}
.sb{padding:12px 16px;position:sticky;top:0;z-index:99;background:var(--bg)}
.si{width:100%;padding:12px 16px 12px 42px;border-radius:var(--r);border:1px solid var(--border);background:var(--card);color:var(--text);font-size:15px;outline:0;transition:.2s}
.si:focus{border-color:var(--accent)}
.sic{position:absolute;left:30px;top:50%;transform:translateY(-50%);font-size:16px;opacity:.5}
.cats{padding:0 16px;overflow-x:auto;display:flex;gap:8px;scrollbar-width:none;-webkit-overflow-scrolling:touch;margin-bottom:12px}
.cats::-webkit-scrollbar{display:none}
.ct{flex-shrink:0;padding:8px 16px;border-radius:20px;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:13px;cursor:pointer;transition:.2s;white-space:nowrap}
.ct.a{background:var(--accent);border-color:var(--accent);color:#fff}
.pg{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;padding:0 16px 16px}
.pc{background:var(--card);border-radius:var(--r);overflow:hidden;border:1px solid var(--border);cursor:pointer;transition:.2s}
.pc:active{transform:scale(.97)}
.pi{width:100%;aspect-ratio:1;object-fit:cover;background:var(--bg2)}
.pf{padding:10px}
.pn{font-size:13px;font-weight:600;line-height:1.3;margin-bottom:6px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.pp{display:flex;align-items:center;gap:6px;flex-wrap:wrap}
.pr{font-size:16px;font-weight:800;color:var(--accent)}
.po{font-size:12px;color:var(--hint);text-decoration:line-through}
.dt{font-size:10px;background:var(--no);color:#fff;padding:2px 6px;border-radius:4px;font-weight:700}
.pep{font-size:11px;color:var(--gold);margin-top:2px}
.mo{position:fixed;inset:0;background:rgba(0,0,0,.6);z-index:200;display:none;align-items:flex-end;justify-content:center;backdrop-filter:blur(4px)}
.mo.a{display:flex}
.pd{background:var(--bg);width:100%;max-height:92vh;border-radius:20px 20px 0 0;overflow-y:auto;animation:su .3s ease}
@keyframes su{from{transform:translateY(100%)}to{transform:translateY(0)}}
.dc{position:absolute;top:16px;right:16px;width:36px;height:36px;border-radius:50%;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:10;font-size:18px;color:#fff}
.di{position:relative;width:100%;aspect-ratio:1;overflow:hidden}
.di img{width:100%;height:100%;object-fit:cover}
.ic{position:absolute;bottom:12px;right:12px;background:rgba(0,0,0,.6);padding:4px 10px;border-radius:12px;font-size:12px}
.ids{position:absolute;bottom:12px;left:50%;transform:translateX(-50%);display:flex;gap:6px}
.ido{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.4);transition:.3s}
.ido.a{background:#fff;width:20px;border-radius:4px}
.dbd{padding:20px 16px}
.dn{font-size:20px;font-weight:800;margin-bottom:8px}
.dd{font-size:14px;color:var(--hint);line-height:1.5;margin-bottom:16px}
.dpr{display:flex;align-items:center;gap:10px;margin-bottom:12px}
.dprc{font-size:26px;font-weight:800;color:var(--accent)}
.dpro{font-size:16px;color:var(--hint);text-decoration:line-through}
.ddi{background:var(--card);border-radius:var(--rs);padding:12px;margin-bottom:16px;border:1px solid var(--border)}
.ddt{font-size:14px;font-weight:700;margin-bottom:8px}
.ddr{display:flex;justify-content:space-between;font-size:13px;padding:3px 0}
.ddr .l{color:var(--hint)}.ddr .v{font-weight:600;color:var(--ok)}
.qs{display:flex;align-items:center;gap:16px;margin-bottom:16px}
.qb{width:40px;height:40px;border-radius:50%;border:1px solid var(--border);background:var(--card);color:var(--text);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.qb:active{background:var(--accent)}
.qv{font-size:20px;font-weight:700;min-width:30px;text-align:center}
.atc{width:100%;padding:16px;border-radius:var(--r);border:none;background:var(--accent);color:#fff;font-size:16px;font-weight:700;cursor:pointer;transition:.2s}
.atc:active{background:var(--accent2);transform:scale(.98)}
.cp{position:fixed;inset:0;background:var(--bg);z-index:300;transform:translateX(100%);transition:.3s ease;display:flex;flex-direction:column}
.cp.o{transform:translateX(0)}
.ch{display:flex;align-items:center;justify-content:space-between;padding:16px;border-bottom:1px solid var(--border)}
.ctl{font-size:20px;font-weight:800}
.cc{font-size:24px;cursor:pointer;padding:4px}
.cis{flex:1;overflow-y:auto;padding:16px}
.ci{display:flex;gap:12px;padding:12px;background:var(--card);border-radius:var(--rs);margin-bottom:10px;border:1px solid var(--border)}
.cig{width:70px;height:70px;border-radius:8px;object-fit:cover;flex-shrink:0}
.cii{flex:1;min-width:0}
.cin{font-size:13px;font-weight:600;margin-bottom:4px;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.cip{font-size:15px;font-weight:700;color:var(--accent);margin-bottom:8px}
.cic{display:flex;align-items:center;gap:10px}
.cqb{width:28px;height:28px;border-radius:50%;border:1px solid var(--border);background:var(--bg2);color:var(--text);font-size:16px;cursor:pointer;display:flex;align-items:center;justify-content:center}
.cir{color:var(--no);cursor:pointer;font-size:18px;margin-left:auto}
.ce{text-align:center;padding:60px 20px;color:var(--hint)}
.cei{font-size:60px;margin-bottom:12px}
.cf{padding:16px;border-top:1px solid var(--border);background:var(--bg2)}
.cpm{display:flex;gap:8px;margin-bottom:12px}
.cpm input{flex:1;padding:10px 14px;border-radius:var(--rs);border:1px solid var(--border);background:var(--card);color:var(--text);font-size:14px;outline:0}
.cpm button{padding:10px 16px;border-radius:var(--rs);border:none;background:var(--accent);color:#fff;font-size:13px;font-weight:600;cursor:pointer}
.cs{margin-bottom:12px}
.csr{display:flex;justify-content:space-between;font-size:14px;padding:4px 0}
.csr.t{font-size:18px;font-weight:800;color:var(--accent);border-top:1px solid var(--border);padding-top:8px;margin-top:4px}
.cob{width:100%;padding:16px;border-radius:var(--r);border:none;background:var(--ok);color:#fff;font-size:16px;font-weight:700;cursor:pointer}
.cob:disabled{opacity:.5;cursor:not-allowed}
.pp2{position:fixed;inset:0;background:var(--bg);z-index:300;transform:translateX(100%);transition:.3s ease;overflow-y:auto}
.pp2.o{transform:translateX(0)}
.ph{padding:20px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid var(--border)}
.pb{font-size:24px;cursor:pointer}
.pc2{padding:16px}
.pcd{background:var(--card);border-radius:var(--r);padding:16px;margin-bottom:12px;border:1px solid var(--border)}
.pcd h3{font-size:15px;margin-bottom:10px}
.prw{display:flex;justify-content:space-between;padding:6px 0;font-size:13px}
.prw .l{color:var(--hint)}.prw .v{font-weight:600}
.tst{position:fixed;bottom:90px;left:50%;transform:translateX(-50%) translateY(100px);background:var(--card);color:var(--text);padding:12px 24px;border-radius:var(--r);font-size:14px;font-weight:600;z-index:500;transition:.3s ease;box-shadow:var(--sh);border:1px solid var(--border)}
.tst.s{transform:translateX(-50%) translateY(0)}
.ld{display:flex;justify-content:center;padding:40px}
.sp{width:36px;height:36px;border:3px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:spn .8s linear infinite}
@keyframes spn{to{transform:rotate(360deg)}}
.sec{display:inline-flex;align-items:center;gap:4px;font-size:11px;color:var(--ok);padding:2px 8px;background:rgba(76,175,80,.1);border-radius:10px}
</style>
</head>
<body>

<div class="hd" id="header">
<div class="ht">
<div><div class="sn">üõç Saturn</div><div class="sec" id="secBadge" style="display:none">üîí Secure</div></div>
<div class="hi">
<div class="hib" onclick="openProfile()">üë§</div>
<div class="hib" onclick="openCart()">üõí<div class="cb" id="cartBadge" style="display:none">0</div></div>
</div>
</div>
<div class="db" id="discBanner" onclick="openProfile()" style="display:none">
<span class="e">üéÅ</span><span class="t" id="discText">–ó–∞–≥—Ä—É–∑–∫–∞...</span><span class="p" id="discPct"></span>
</div>
</div>

<div class="sb"><span class="sic">üîç</span><input class="si" type="text" placeholder="–ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..." id="searchInput" oninput="filterProducts()"></div>
<div class="cats" id="catsBox"></div>
<div class="pg" id="prodGrid"><div class="ld"><div class="sp"></div></div></div>

<div class="mo" id="prodModal"><div class="pd" id="prodDetail"></div></div>

<div class="cp" id="cartPanel">
<div class="ch"><span class="ctl">üõí –ö–æ—Ä–∑–∏–Ω–∞</span><span class="cc" onclick="closeCart()">‚úï</span></div>
<div class="cis" id="cartItems"></div>
<div class="cf" id="cartFooter" style="display:none">
<div class="cpm"><input type="text" placeholder="–ü—Ä–æ–º–æ–∫–æ–¥" id="promoInput" maxlength="20"><button onclick="applyPromo()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button></div>
<div class="cs" id="cartSum"></div>
<button class="cob" id="orderBtn" onclick="submitOrder()">üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>
</div>
</div>

<div class="pp2" id="profPanel">
<div class="ph"><span class="pb" onclick="closeProfile()">‚Üê</span><span style="font-size:18px;font-weight:700">üë§ –ü—Ä–æ—Ñ–∏–ª—å</span></div>
<div class="pc2" id="profContent"><div class="ld"><div class="sp"></div></div></div>
</div>

<div class="tst" id="toast"></div>

<script>
const A={
tg:null,user:null,initData:'',initDataUnsafe:null,apiUrl:'',
products:[],categories:[],cart:[],userDiscount:null,config:null,
activeCat:'all',curProd:null,curQty:1,curImgIdx:0,prodImgs:[],

async init(){
try{
this.tg=window.Telegram?.WebApp;
if(!this.tg){this.showErr('–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç');return}
this.tg.ready();this.tg.expand();this.applyTheme();
this.initData=this.tg.initData;this.initDataUnsafe=this.tg.initDataUnsafe;
this.user=this.initDataUnsafe?.user||null;
await this.fetchConfig();
await Promise.all([this.loadProducts(),this.loadCategories(),this.loadUserDiscount()]);
this.loadCart();
if(this.initData){const b=document.getElementById('secBadge');if(b)b.style.display='inline-flex'}
}catch(e){console.error(e);this.toast('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏')}
},

async fetchConfig(){
const m=document.querySelector('meta[name="api-url"]');
let u=m?.content||'';
if(u){try{const r=await fetch(`${u}/api/config`);if(r.ok){this.config=await r.json();this.apiUrl=this.config.api_url;return}}catch(e){}}
this.apiUrl=window.__API_URL__||'';
},

async apiReq(ep,opt={}){
if(!this.apiUrl)throw new Error('No API');
const h={'Content-Type':'application/json',...opt.headers};
if(this.initData)h['Authorization']=`Bearer ${this.initData}`;
const r=await fetch(`${this.apiUrl}${ep}`,{...opt,headers:h});
if(r.status===401)this.toast('‚ö†Ô∏è –°–µ—Å—Å–∏—è –∏—Å—Ç–µ–∫–ª–∞');
if(r.status===403)this.toast('‚õî –î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â—ë–Ω');
if(r.status===429)this.toast('‚è≥ –°–ª–∏—à–∫–æ–º –º–Ω–æ–≥–æ –∑–∞–ø—Ä–æ—Å–æ–≤');
if(r.status>=400)throw new Error(r.status);
return r;
},

uid(){return this.user?.id||0},

applyTheme(){
if(!this.tg?.themeParams)return;const t=this.tg.themeParams,s=document.documentElement.style;
if(t.bg_color)s.setProperty('--bg',t.bg_color);
if(t.text_color)s.setProperty('--text',t.text_color);
if(t.hint_color)s.setProperty('--hint',t.hint_color);
if(t.button_color){s.setProperty('--accent',t.button_color)}
if(t.secondary_bg_color)s.setProperty('--bg2',t.secondary_bg_color);
},

async loadProducts(){
try{const r=await fetch(`${this.apiUrl}/api/products`);const d=await r.json();this.products=d.products||[];this.renderProds()}
catch(e){document.getElementById('prodGrid').innerHTML='<div style="text-align:center;padding:40px;grid-column:1/-1;color:var(--hint)">üòî –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Ç–æ–≤–∞—Ä—ã</div>'}
},

async loadCategories(){
try{const r=await fetch(`${this.apiUrl}/api/categories`);const d=await r.json();this.categories=d.categories||[];this.renderCats()}catch(e){}
},

async loadUserDiscount(){
const u=this.uid();if(!u||!this.initData)return;
try{const r=await this.apiReq(`/api/user/${u}`);const d=await r.json();this.userDiscount=d.discount;this.updDiscBanner()}catch(e){}
},

async loadProdDisc(pid){
const u=this.uid();if(!u||!this.initData)return null;
try{const r=await this.apiReq(`/api/user/${u}/product/${pid}`);const d=await r.json();return d.discount}catch(e){return null}
},

renderCats(){
const c=document.getElementById('catsBox');if(!c)return;
let h=`<button class="ct ${this.activeCat==='all'?'a':''}" onclick="A.setCat('all')">üè™ –í—Å–µ</button>`;
this.categories.forEach(cat=>{if(cat.slug==='all')return;h+=`<button class="ct ${this.activeCat===cat.slug?'a':''}" onclick="A.setCat('${this.esc(cat.slug)}')">${this.esc(cat.name)}</button>`});
c.innerHTML=h;
},

renderProds(){
const g=document.getElementById('prodGrid');if(!g)return;
const s=(document.getElementById('searchInput')?.value||'').toLowerCase();
let f=this.products.filter(p=>{
if(this.activeCat!=='all'&&p.category!==this.activeCat)return false;
if(s&&!p.name.toLowerCase().includes(s)&&!(p.description||'').toLowerCase().includes(s))return false;
return true;
});
if(!f.length){g.innerHTML='<div style="text-align:center;padding:40px;grid-column:1/-1;color:var(--hint)">üòî –¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</div>';return}
g.innerHTML=f.map(p=>this.prodCard(p)).join('');
},

prodCard(p){
const img=(p.images&&p.images[0])||(p.image_urls&&p.image_urls[0])||'';
const ho=p.old_price&&p.old_price>0;
const dp=ho?Math.round((1-p.price/p.old_price)*100):0;
let ph='';
if(this.userDiscount&&this.userDiscount.total>0){ph=`<div class="pep">üë§ ${Math.round(p.price*(1-this.userDiscount.total/100))}‚ÇΩ</div>`}
return`<div class="pc" onclick="A.openProd(${p.id})"><img class="pi" src="${this.esc(img)}" alt="${this.esc(p.name)}" loading="lazy" onerror="this.style.display='none'"><div class="pf"><div class="pn">${this.esc(p.name)}</div><div class="pp"><span class="pr">${p.price}‚ÇΩ</span>${ho?`<span class="po">${p.old_price}‚ÇΩ</span>`:''}${dp>0?`<span class="dt">-${dp}%</span>`:''}</div>${ph}</div></div>`;
},

async openProd(id){
const p=this.products.find(x=>x.id===id);if(!p)return;
this.curProd=p;
const imgs=p.images||p.image_urls||[];
const ho=p.old_price&&p.old_price>0;
let di=null;
if(this.uid()&&this.initData)di=await this.loadProdDisc(id);
let dh='';
if(di&&di.total>0){
const d=di.details||{};
dh=`<div class="ddi"><div class="ddt">üéÅ –í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞</div>
${d.first_order?`<div class="ddr"><span class="l">üéâ –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</span><span class="v">-${d.first_order}%</span></div>`:''}
${d.referral?`<div class="ddr"><span class="l">üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è</span><span class="v">-${d.referral}%</span></div>`:''}
${d.review?`<div class="ddr"><span class="l">‚≠ê –ó–∞ –æ—Ç–∑—ã–≤—ã</span><span class="v">-${d.review}%</span></div>`:''}
${d.promo?`<div class="ddr"><span class="l">üéü –ü—Ä–æ–º–æ–∫–æ–¥</span><span class="v">-${d.promo}%</span></div>`:''}
${d.admin?`<div class="ddr"><span class="l">‚≠ê –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</span><span class="v">-${d.admin}%</span></div>`:''}
<div class="ddr" style="font-weight:700;border-top:1px solid var(--border);padding-top:6px;margin-top:4px"><span>–ò—Ç–æ–≥–æ</span><span class="v" style="font-size:16px">-${di.total}%</span></div>
${di.final_price?`<div class="ddr" style="margin-top:4px"><span style="color:var(--gold);font-weight:700">üí∞ –í–∞—à–∞ —Ü–µ–Ω–∞</span><span style="color:var(--gold);font-weight:700;font-size:18px">${di.final_price}‚ÇΩ</span></div>`:''}</div>`;
}
const det=document.getElementById('prodDetail');
det.innerHTML=`<div class="di" id="dImgs"><div class="dc" onclick="A.closeProd()">‚úï</div><img src="${this.esc(imgs[0]||'')}" id="dMainImg" alt="" onerror="this.style.display='none'">${imgs.length>1?`<div class="ic" id="imgCnt">1/${imgs.length}</div><div class="ids" id="imgDots">${imgs.map((_,i)=>`<div class="ido ${i===0?'a':''}" onclick="A.setImg(${i})"></div>`).join('')}</div>`:''}</div>
<div class="dbd"><div class="dn">${this.esc(p.name)}</div><div class="dd">${this.esc(p.description||'')}</div>
<div class="dpr"><span class="dprc">${p.price}‚ÇΩ</span>${ho?`<span class="dpro">${p.old_price}‚ÇΩ</span>`:''}</div>${dh}
<div class="qs"><button class="qb" onclick="A.chgQty(-1)">‚àí</button><span class="qv" id="qtyVal">1</span><button class="qb" onclick="A.chgQty(1)">+</button></div>
<button class="atc" onclick="A.addToCart()">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button></div>`;
if(imgs.length>1)this.setupSwipe(imgs);
document.getElementById('prodModal').classList.add('a');
this.curQty=1;this.curImgIdx=0;this.prodImgs=imgs;
},

chgQty(d){this.curQty=Math.max(1,Math.min(99,this.curQty+d));const e=document.getElementById('qtyVal');if(e)e.textContent=this.curQty},

setImg(i){
if(i<0||i>=this.prodImgs.length)return;this.curImgIdx=i;
const img=document.getElementById('dMainImg');if(img)img.src=this.prodImgs[i];
const c=document.getElementById('imgCnt');if(c)c.textContent=`${i+1}/${this.prodImgs.length}`;
document.querySelectorAll('.ido').forEach((d,j)=>d.classList.toggle('a',j===i));
},

setupSwipe(imgs){
const c=document.getElementById('dImgs');if(!c)return;let sx=0;
c.addEventListener('touchstart',e=>{sx=e.touches[0].clientX});
c.addEventListener('touchend',e=>{const d=sx-e.changedTouches[0].clientX;if(Math.abs(d)>50){if(d>0&&this.curImgIdx<imgs.length-1)this.setImg(this.curImgIdx+1);else if(d<0&&this.curImgIdx>0)this.setImg(this.curImgIdx-1)}});
},

closeProd(){document.getElementById('prodModal').classList.remove('a');this.curProd=null},

addToCart(){
if(!this.curProd)return;
const ex=this.cart.find(c=>c.id===this.curProd.id);
if(ex)ex.qty+=this.curQty;
else this.cart.push({id:this.curProd.id,name:this.curProd.name,price:this.curProd.price,image:(this.curProd.images||this.curProd.image_urls||[])[0]||'',qty:this.curQty});
this.saveCart();this.updBadge();this.closeProd();this.toast(`‚úÖ ${this.curProd.name} –¥–æ–±–∞–≤–ª–µ–Ω`);
if(this.tg?.HapticFeedback)this.tg.HapticFeedback.notificationOccurred('success');
},

rmCart(id){this.cart=this.cart.filter(c=>c.id!==id);this.saveCart();this.renderCart();this.updBadge()},

updCartQty(id,d){const it=this.cart.find(c=>c.id===id);if(!it)return;it.qty+=d;if(it.qty<=0){this.rmCart(id);return}this.saveCart();this.renderCart();this.updBadge()},

saveCart(){try{localStorage.setItem('saturn_cart',JSON.stringify(this.cart))}catch(e){}},

loadCart(){try{const s=localStorage.getItem('saturn_cart');if(s)this.cart=JSON.parse(s)}catch(e){this.cart=[]}this.updBadge()},

updBadge(){const b=document.getElementById('cartBadge');const t=this.cart.reduce((s,c)=>s+c.qty,0);if(b){b.textContent=t;b.style.display=t>0?'flex':'none'}},

openCart(){this.renderCart();document.getElementById('cartPanel').classList.add('o')},
closeCart(){document.getElementById('cartPanel').classList.remove('o')},

renderCart(){
const c=document.getElementById('cartItems'),f=document.getElementById('cartFooter');
if(!this.cart.length){c.innerHTML='<div class="ce"><div class="cei">üõí</div><div>–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</div></div>';f.style.display='none';return}
c.innerHTML=this.cart.map(it=>`<div class="ci"><img class="cig" src="${this.esc(it.image)}" alt="" onerror="this.style.display='none'"><div class="cii"><div class="cin">${this.esc(it.name)}</div><div class="cip">${it.price*it.qty}‚ÇΩ</div><div class="cic"><button class="cqb" onclick="A.updCartQty(${it.id},-1)">‚àí</button><span>${it.qty}</span><button class="cqb" onclick="A.updCartQty(${it.id},1)">+</button><span class="cir" onclick="A.rmCart(${it.id})">üóë</span></div></div></div>`).join('');
const sub=this.cart.reduce((s,c)=>s+c.price*c.qty,0);
const disc=this.userDiscount?.total||0;
const da=Math.round(sub*disc/100);
const tot=sub-da;
document.getElementById('cartSum').innerHTML=`<div class="csr"><span>–¢–æ–≤–∞—Ä—ã (${this.cart.reduce((s,c)=>s+c.qty,0)})</span><span>${sub}‚ÇΩ</span></div>${disc>0?`<div class="csr" style="color:var(--ok)"><span>üéÅ –°–∫–∏–¥–∫–∞ ${disc}%</span><span>-${da}‚ÇΩ</span></div>`:''}<div class="csr t"><span>–ò—Ç–æ–≥–æ</span><span>${tot}‚ÇΩ</span></div>`;
f.style.display='block';
},

async applyPromo(){
const inp=document.getElementById('promoInput');const code=(inp?.value||'').trim();
if(!code){this.toast('‚ùå –í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥');return}
const u=this.uid();if(!u||!this.initData){this.toast('‚ö†Ô∏è –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è –Ω–µ –ø—Ä–æ–π–¥–µ–Ω–∞');return}
try{
const r=await this.apiReq('/api/promo/apply',{method:'POST',body:JSON.stringify({user_id:u,code})});
const d=await r.json();
if(d.success){this.toast(`‚úÖ ${d.code} –ø—Ä–∏–º–µ–Ω—ë–Ω! -${d.discount}%`);if(d.discount_info){this.userDiscount=d.discount_info;this.updDiscBanner();this.renderCart();this.renderProds()}inp.value=''}
else this.toast(`‚ùå ${d.error||'–û—à–∏–±–∫–∞'}`);
}catch(e){this.toast('‚ùå –û—à–∏–±–∫–∞')}
},

async submitOrder(){
if(!this.cart.length)return;
const u=this.uid();if(!u){this.toast('‚ö†Ô∏è –û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram –±–æ—Ç');return}
const btn=document.getElementById('orderBtn');btn.disabled=true;btn.textContent='‚è≥ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ...';
try{
const sub=this.cart.reduce((s,c)=>s+c.price*c.qty,0);
const disc=this.userDiscount?.total||0;
const fin=Math.round(sub*(1-disc/100));
this.tg.sendData(JSON.stringify({action:'order',items:this.cart.map(c=>({id:c.id,name:c.name,price:c.price,qty:c.qty})),total:sub,discount:disc,final_price:fin,discount_details:this.userDiscount?.details||{}}));
this.cart=[];this.saveCart();this.updBadge();this.closeCart();this.toast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
if(this.tg?.HapticFeedback)this.tg.HapticFeedback.notificationOccurred('success');
}catch(e){this.toast('‚ùå –û—à–∏–±–∫–∞')}finally{btn.disabled=false;btn.textContent='üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑'}
},

openProfile(){document.getElementById('profPanel').classList.add('o');this.renderProf()},
closeProfile(){document.getElementById('profPanel').classList.remove('o')},

renderProf(){
const c=document.getElementById('profContent');const d=this.userDiscount,u=this.user;
if(!u){c.innerHTML='<div style="text-align:center;padding:40px;color:var(--hint)">‚ö†Ô∏è –î–∞–Ω–Ω—ã–µ –Ω–µ–¥–æ—Å—Ç—É–ø–Ω—ã</div>';return}
const ln={none:'–ù–µ—Ç —É—Ä–æ–≤–Ω—è',bronze:'ü•â –ë—Ä–æ–Ω–∑–∞',silver:'ü•à –°–µ—Ä–µ–±—Ä–æ',gold:'ü•á –ó–æ–ª–æ—Ç–æ'};
c.innerHTML=`<div class="pcd"><h3>üë§ ${this.esc(u.first_name||'–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å')}</h3>${u.username?`<div class="prw"><span class="l">Username</span><span class="v">@${this.esc(u.username)}</span></div>`:''}</div>
${d?`<div class="pcd"><h3>üéÅ –°–∫–∏–¥–∫–∏</h3>
<div class="prw"><span class="l">–û–±—â–∞—è —Å–∫–∏–¥–∫–∞</span><span class="v" style="color:var(--gold);font-size:18px">${d.total}%</span></div>
<div class="prw"><span class="l">üë• –£—Ä–æ–≤–µ–Ω—å</span><span class="v">${ln[d.ref_level]||'–ù–µ—Ç'}</span></div>
<div class="prw"><span class="l">üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è</span><span class="v">${d.referral}%</span></div>
<div class="prw"><span class="l">‚≠ê –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</span><span class="v">${d.admin}%</span></div>
<div class="prw"><span class="l">‚≠ê –ó–∞ –æ—Ç–∑—ã–≤—ã</span><span class="v">${d.review}%</span></div>
<div class="prw"><span class="l">üéü –ü—Ä–æ–º–æ–∫–æ–¥</span><span class="v">${d.promo}%</span></div>
${d.promo_code?`<div class="prw"><span class="l">–ö–æ–¥</span><span class="v">${this.esc(d.promo_code)}</span></div>`:''}
${!d.first_order_used?'<div style="margin-top:8px;padding:8px;background:rgba(76,175,80,.1);border-radius:8px;font-size:13px;color:var(--ok)">üéâ –°–∫–∏–¥–∫–∞ –Ω–∞ –ø–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑ –¥–æ—Å—Ç—É–ø–Ω–∞!</div>':''}</div>
<div class="pcd"><h3>üèÜ –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è –ø—Ä–æ–≥—Ä–∞–º–º–∞</h3><div class="prw"><span class="l">–î—Ä—É–∑–µ–π</span><span class="v">${d.ref_count||0}</span></div>
<div style="margin-top:8px;font-size:12px;color:var(--hint)">ü•â 1+ –¥—Ä—É–≥ ‚Ä¢ ü•à 5+ –¥—Ä—É–∑–µ–π ‚Ä¢ ü•á 10+ –¥—Ä—É–∑–µ–π</div></div>`:'<div class="pcd"><div style="text-align:center;color:var(--hint)">–ó–∞–≥—Ä—É–∑–∫–∞...</div></div>'}`;
},

updDiscBanner(){
const b=document.getElementById('discBanner'),t=document.getElementById('discText'),p=document.getElementById('discPct');
if(!this.userDiscount||this.userDiscount.total<=0){if(b)b.style.display='none';return}
if(b)b.style.display='flex';if(t)t.textContent='–í–∞—à–∞ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è —Å–∫–∏–¥–∫–∞';if(p)p.textContent=`-${this.userDiscount.total}%`;
},

setCat(s){this.activeCat=s;this.renderCats();this.renderProds()},

toast(m){const t=document.getElementById('toast');if(!t)return;t.textContent=m;t.classList.add('s');setTimeout(()=>t.classList.remove('s'),2500)},

showErr(m){document.body.innerHTML=`<div style="display:flex;align-items:center;justify-content:center;min-height:100vh;text-align:center;padding:20px;color:var(--no)"><div><div style="font-size:60px;margin-bottom:16px">‚ö†Ô∏è</div><div style="font-size:18px;font-weight:700">${this.esc(m)}</div></div></div>`},

esc(t){if(!t)return'';const m={'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'};return String(t).replace(/[&<>"']/g,c=>m[c])}
};

function filterProducts(){A.renderProds()}
function openCart(){A.openCart()}
function closeCart(){A.closeCart()}
function openProfile(){A.openProfile()}
function closeProfile(){A.closeProfile()}
function applyPromo(){A.applyPromo()}
function submitOrder(){A.submitOrder()}
document.getElementById('prodModal')?.addEventListener('click',function(e){if(e.target===this)A.closeProd()});
document.addEventListener('DOMContentLoaded',()=>A.init());
</script>
</body>
</html>

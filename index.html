<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Premium Shop</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
*{margin:0;padding:0;box-sizing:border-box}:root{--bg:#0f0f1a;--bg2:#1a1a2e;--text:#fff;--hint:#888;--accent:linear-gradient(135deg,#667eea,#764ba2);--accent-solid:#667eea;--green:linear-gradient(135deg,#4ade80,#22c55e);--green-solid:#22c55e;--red:linear-gradient(135deg,#ff6b6b,#ee5a6f);--red-solid:#ff6b6b;--orange:#f59e0b}body.light-theme{--bg:#f5f5f7;--bg2:#ffffff;--text:#1a1a2e;--hint:#666}body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:100px;overflow-x:hidden;transition:background .3s,color .3s}.header{background:var(--accent);padding:20px;text-align:center;box-shadow:0 4px 20px rgba(102,126,234,.4);position:relative;overflow:hidden}.header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,.1) 50%,transparent 70%);animation:hShine 4s ease-in-out infinite}@keyframes hShine{0%{transform:translateX(-100%) rotate(45deg)}100%{transform:translateX(100%) rotate(45deg)}}.header h1{font-size:24px;margin-bottom:4px;text-shadow:0 2px 10px rgba(0,0,0,.2)}.header p{font-size:13px;opacity:.9}.discount-badge{background:var(--green);padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:6px;margin-top:10px;animation:pulse 2s infinite;cursor:pointer}@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.03)}}.discount-badge.has-promo{background:var(--orange)}.header-buttons{position:absolute;top:10px;right:10px;display:flex;gap:8px}.header-btn{width:36px;height:36px;border:none;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s;backdrop-filter:blur(10px)}.favorites-btn{position:absolute;top:10px;left:10px}.favorites-count{position:absolute;top:-4px;right:-4px;background:var(--red-solid);color:#fff;width:18px;height:18px;border-radius:50%;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:700}.categories{display:flex;gap:10px;padding:16px 12px;overflow-x:auto;-webkit-overflow-scrolling:touch}.categories::-webkit-scrollbar{height:4px}.categories::-webkit-scrollbar-thumb{background:var(--accent-solid);border-radius:2px}.cat-btn{padding:10px 18px;border:none;border-radius:20px;background:var(--bg2);color:var(--text);font-size:13px;font-weight:500;white-space:nowrap;cursor:pointer;transition:all .4s;box-shadow:0 2px 8px rgba(0,0,0,.15);flex-shrink:0}.cat-btn.active{background:var(--accent);color:#fff;box-shadow:0 4px 16px rgba(102,126,234,.5);transform:scale(1.08)}.search{padding:0 12px 12px}.search input{width:100%;padding:12px 16px;border:2px solid transparent;border-radius:12px;background:var(--bg2);color:var(--text);font-size:14px;outline:none;transition:all .3s;box-shadow:0 2px 8px rgba(0,0,0,.1)}.search input:focus{border-color:var(--accent-solid);box-shadow:0 4px 16px rgba(102,126,234,.3)}.products{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0 12px}.product{background:var(--bg2);border-radius:16px;padding:12px;cursor:pointer;position:relative;transition:all .4s;box-shadow:0 4px 12px rgba(0,0,0,.1);animation:pApp .6s backwards;overflow:hidden}@keyframes pApp{from{opacity:0;transform:translateY(40px) scale(.9)}to{opacity:1;transform:translateY(0) scale(1)}}.product:active{transform:scale(.97)}.product-favorite{position:absolute;top:8px;right:8px;z-index:2;width:32px;height:32px;border:none;border-radius:50%;background:rgba(0,0,0,.5);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px);transition:all .4s}.product-favorite.active{background:var(--red-solid)}.product-img{width:100%;height:120px;object-fit:cover;border-radius:12px;margin-bottom:10px;transition:all .5s}.product-name{font-size:13px;font-weight:600;margin-bottom:8px;line-height:1.3;min-height:34px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}.product-price{font-size:16px;font-weight:700}.product-price.discounted{color:var(--green-solid)}.product-price .old{font-size:12px;color:var(--hint);text-decoration:line-through;margin-right:6px}.cart-btn{position:fixed;bottom:16px;left:12px;right:12px;background:var(--green);padding:16px;border-radius:16px;display:flex;justify-content:space-between;align-items:center;font-weight:600;cursor:pointer;box-shadow:0 8px 32px rgba(34,197,94,.5);z-index:100;color:#fff;border:none;font-size:15px}#cart-count{background:#fff;color:var(--green-solid);width:24px;height:24px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:700}.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000}.modal.active{display:block}.modal-bg{position:absolute;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(8px)}.modal-box{position:absolute;bottom:0;left:0;right:0;background:var(--bg);border-radius:28px 28px 0 0;max-height:90vh;overflow-y:auto;padding:24px;animation:mSU .5s}@keyframes mSU{from{transform:translateY(100%)}to{transform:translateY(0)}}.modal-close{position:absolute;top:16px;right:16px;width:36px;height:36px;border:none;border-radius:50%;background:var(--bg2);color:var(--text);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:10}.modal-img{width:100%;height:280px;object-fit:cover;border-radius:16px}.modal-gallery{position:relative;margin-bottom:20px}.gallery-nav{position:absolute;top:50%;transform:translateY(-50%);width:36px;height:36px;border:none;border-radius:50%;background:rgba(0,0,0,.5);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:5}.gallery-nav.prev{left:8px}.gallery-nav.next{right:8px}.modal-name{font-size:18px;font-weight:700;margin-bottom:12px}.modal-desc{font-size:14px;color:var(--hint);line-height:1.6;margin-bottom:16px;white-space:pre-wrap}.modal-price-box{background:var(--accent);border-radius:16px;padding:20px;text-align:center;margin:16px 0}.modal-price-box .old{font-size:14px;text-decoration:line-through;opacity:.7}.modal-price-box .new{font-size:28px;font-weight:700}.modal-price-box .discount-info{font-size:12px;opacity:.8;margin-top:4px}.modal-btns{display:flex;gap:12px;margin-top:16px}.btn{flex:1;padding:16px;border:none;border-radius:14px;font-size:15px;font-weight:600;cursor:pointer;transition:all .3s}.btn-cart{background:var(--bg2);color:var(--text)}.btn-buy{background:var(--green);color:#fff}.qty-controls{display:flex;align-items:center;justify-content:center;gap:16px;margin:16px 0}.qty-btn{width:40px;height:40px;border:none;border-radius:50%;background:var(--bg2);color:var(--text);font-size:20px;cursor:pointer}.qty-value{font-size:20px;font-weight:700;min-width:30px;text-align:center}.cart-modal .cart-item{display:flex;align-items:center;gap:12px;background:var(--bg2);border-radius:12px;padding:12px;margin-bottom:10px;position:relative}.cart-item img{width:60px;height:60px;border-radius:10px;object-fit:cover}.cart-item-info{flex:1}.cart-item-name{font-size:13px;font-weight:600;margin-bottom:4px}.cart-item-price{font-size:14px;color:var(--green-solid)}.cart-item-qty{display:flex;align-items:center;gap:8px}.cart-item-qty button{width:28px;height:28px;border:none;border-radius:50%;background:var(--bg);color:var(--text);cursor:pointer}.cart-item-remove{position:absolute;top:8px;right:8px;background:none;border:none;color:var(--red-solid);font-size:18px;cursor:pointer}.promo-section{margin-top:16px;padding:16px;background:var(--bg2);border-radius:12px}.promo-title{font-size:14px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}.promo-input-row{display:flex;gap:8px}.promo-input{flex:1;padding:12px;border:2px solid transparent;border-radius:10px;background:var(--bg);color:var(--text);font-size:14px;outline:none;text-transform:uppercase}.promo-input:focus{border-color:var(--accent-solid)}.promo-apply-btn{padding:12px 20px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:600;cursor:pointer}.promo-applied{display:flex;align-items:center;justify-content:space-between;padding:10px;background:var(--green);border-radius:10px;margin-top:10px}.promo-applied-text{font-size:13px;font-weight:600}.promo-remove-btn{background:rgba(255,255,255,.2);border:none;color:#fff;width:24px;height:24px;border-radius:50%;cursor:pointer;font-size:14px}.promo-error{color:var(--red-solid);font-size:12px;margin-top:8px}.discount-breakdown{margin-top:12px;padding:12px;background:var(--bg);border-radius:10px;font-size:13px}.discount-row{display:flex;justify-content:space-between;margin-bottom:6px;color:var(--hint)}.discount-row.active{color:var(--green-solid)}.discount-row:last-child{margin-bottom:0}.cart-summary{margin-top:20px;padding-top:16px;border-top:1px solid rgba(255,255,255,.1)}.cart-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}.cart-row.discount{color:var(--green-solid)}.cart-row.total{font-size:18px;font-weight:700;margin-top:12px}.cart-checkout{width:100%;padding:16px;border:none;border-radius:14px;background:var(--green);color:#fff;font-size:16px;font-weight:700;cursor:pointer;margin-top:16px}.fullscreen-viewer{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:#000;z-index:2000;flex-direction:column}.fullscreen-viewer.active{display:flex}.fullscreen-header{padding:16px;display:flex;justify-content:space-between;color:#fff}.fullscreen-body{flex:1;display:flex;align-items:center;justify-content:center;overflow:hidden}.fullscreen-img{max-width:100%;max-height:100%;object-fit:contain}.fullscreen-close{background:none;border:none;color:#fff;font-size:28px;cursor:pointer}.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--bg2);color:var(--text);padding:12px 24px;border-radius:30px;z-index:2000;animation:tIn .3s,tOut .3s 1.7s forwards;box-shadow:0 4px 20px rgba(0,0,0,.3)}@keyframes tIn{from{opacity:0;transform:translateX(-50%) translateY(20px)}to{opacity:1;transform:translateX(-50%) translateY(0)}}@keyframes tOut{to{opacity:0}}.loader{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:3000;flex-direction:column;gap:16px}.loader.hidden{display:none}.spinner{width:50px;height:50px;border:4px solid var(--bg2);border-top-color:var(--accent-solid);border-radius:50%;animation:spin 1s linear infinite}@keyframes spin{to{transform:rotate(360deg)}}.loader-text{color:var(--hint);font-size:14px}.empty-state{text-align:center;padding:60px 20px;color:var(--hint)}.empty-state-icon{font-size:60px;margin-bottom:16px}.discount-details-modal{padding:20px}.discount-details-title{font-size:18px;font-weight:700;margin-bottom:16px;text-align:center}.discount-detail-item{display:flex;justify-content:space-between;padding:12px;background:var(--bg2);border-radius:10px;margin-bottom:8px}.discount-detail-item.active{border-left:3px solid var(--green-solid)}.discount-detail-label{display:flex;align-items:center;gap:8px}.discount-detail-value{font-weight:700;color:var(--green-solid)}.confetti{position:fixed;width:10px;height:10px;top:-10px;z-index:3000;animation:cFall 3s linear forwards;pointer-events:none}@keyframes cFall{to{transform:translateY(100vh) rotate(720deg);opacity:0}}
</style>
</head>
<body>
<div class="loader" id="loader">
<div class="spinner"></div>
<div class="loader-text">–ó–∞–≥—Ä—É–∑–∫–∞ –º–∞–≥–∞–∑–∏–Ω–∞...</div>
</div>
<div class="app">
<header class="header">
<h1>üõç Premium Shop</h1>
<p>–¢–æ–≤–∞—Ä—ã –¥–µ—à–µ–≤–ª–µ –º–∞—Ä–∫–µ—Ç–ø–ª–µ–π—Å–æ–≤!</p>
<div class="discount-badge" id="user-discount" style="display:none" onclick="showDiscountDetails()">
<span>üéÅ</span>
<span>–í–∞—à–∞ —Å–∫–∏–¥–∫–∞: <b id="discount-value">0</b>%</span>
<span>‚ÑπÔ∏è</span>
</div>
<button class="header-btn favorites-btn" onclick="openFavorites()">‚ù§Ô∏è<span class="favorites-count" id="fav-count" style="display:none">0</span></button>
<div class="header-buttons">
<button class="header-btn" onclick="toggleTheme()">üåô</button>
</div>
</header>
<div id="catalog">
<div class="categories" id="categories"></div>
<div class="search"><input type="text" id="search" placeholder="üîç –ü–æ–∏—Å–∫ —Ç–æ–≤–∞—Ä–æ–≤..."></div>
<div class="products" id="products"></div>
</div>
<button class="cart-btn" id="cart-btn" style="display:none" onclick="openCart()">
<span id="cart-count">0</span>
<span>üõí –ö–æ—Ä–∑–∏–Ω–∞</span>
<span id="cart-sum">0‚ÇΩ</span>
</button>
<div class="modal" id="modal">
<div class="modal-bg" onclick="closeModal()"></div>
<div class="modal-box" id="modal-box"></div>
</div>
<div class="modal cart-modal" id="cart-modal">
<div class="modal-bg" onclick="closeCart()"></div>
<div class="modal-box" id="cart-box"></div>
</div>
<div class="modal" id="discount-modal">
<div class="modal-bg" onclick="closeDiscountModal()"></div>
<div class="modal-box discount-details-modal" id="discount-details-box"></div>
</div>
<div class="fullscreen-viewer" id="fullscreen-viewer">
<div class="fullscreen-header">
<div id="fs-counter">1/1</div>
<button class="fullscreen-close" onclick="closeFullscreen()">√ó</button>
</div>
<div class="fullscreen-body">
<img id="fs-img" class="fullscreen-img" src="">
</div>
</div>
</div>
<script>
const tg=window.Telegram?.WebApp;
const API_URL='http://localhost:8080';

const PRODUCTS=[
{id:1749700001,name:"üî• –ü–µ—Ä—á–∞—Ç–∫–∏ NIKE THERMO-FIT 2.0 ACADEMY + –ù–û–°–ö–ò –í –ü–û–î–ê–†–û–ö üéÅ",image:"https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433665218002227615_y.jpg",images:["https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433665218002227615_y.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5435917017815911629_y.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932542681_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932543855_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932543856_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932543857_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932542798_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932543859_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932543858_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5433724930932543860_w.jpg"],price:500,category:"clothes",description:"üíé –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:\n‚Äî –ú–æ–¥–µ–ª—å: Thermo-Fit 2.0 Academy\n‚Äî –ö–∞—á–µ—Å—Ç–≤–æ: LUX\n‚Äî –†–∞–∑–º–µ—Ä: One size\n‚Äî –ú–∞—Ç–µ—Ä–∏–∞–ª: –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—á–Ω—ã–π —Ç–µ—Ä–º–æ—Ñ–ª–∏—Å\n‚Äî –°–µ–∑–æ–Ω: –û—Å–µ–Ω—å / –ó–∏–º–∞\n\n‚úÖ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:\n‚Ä¢ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è Touch Screen\n‚Ä¢ –°—Ü–µ–ø–ª–µ–Ω–∏–µ: –°–∏–ª–∏–∫–æ–Ω–æ–≤—ã–µ –Ω–∞—Å–µ—á–∫–∏\n‚Ä¢ –õ–æ–≥–æ—Ç–∏–ø: —É—Å—Ç–æ–π—á–∏–≤ –∫ –∏–∑–Ω–æ—Å—É\n\nüì¶ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è:\n1. –ü–µ—Ä—á–∞—Ç–∫–∏ Nike\n2. –§–∏—Ä–º–µ–Ω–Ω—ã–π 3D —Å—Ç–∏–∫–µ—Ä\n3. –ë—Ä–µ–Ω–¥–æ–≤—ã–µ –Ω–æ—Å–∫–∏ Nike"},
{id:1749700002,name:"üî• –ü–µ—Ä—á–∞—Ç–∫–∏ NIKE ACADEMY HYPERWARM + –ù–æ—Å–∫–∏",image:"https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602355_w.jpg",images:["https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602355_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602398_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602399_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602401_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602403_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602404_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602405_w.jpg","https://cdn.jsdelivr.net/gh/krivenkovigor47-pixel/shop-webapp@main/photo_5442739311372602407_w.jpg"],price:500,category:"clothes",description:"üíé –•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:\n‚Äî –ú–æ–¥–µ–ª—å: Nike Academy Hyperwarm\n‚Äî –ö–∞—á–µ—Å—Ç–≤–æ: LUX\n‚Äî –†–∞–∑–º–µ—Ä—ã: L | XL | 2XL\n‚Äî –¶–≤–µ—Ç: –ß—ë—Ä–Ω—ã–π\n‚Äî –ú–∞—Ç–µ—Ä–∏–∞–ª: –¢–µ–ø–ª—ã–π —ç–ª–∞—Å—Ç–∏—á–Ω—ã–π —Ç–µ—Ä–º–æ—Ñ–ª–∏—Å\n‚Äî –°–µ–∑–æ–Ω: –û—Å–µ–Ω—å / –ó–∏–º–∞\n\n‚úÖ –û—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏:\n‚Ä¢ –¢–µ—Ö–Ω–æ–ª–æ–≥–∏—è Touch Screen\n‚Ä¢ Reflective: —Å–≤–µ—Ç–æ–æ—Ç—Ä–∞–∂–∞—é—â–∏–π –ª–æ–≥–æ—Ç–∏–ø\n‚Ä¢ –°—Ü–µ–ø–ª–µ–Ω–∏–µ: —Å–∏–ª–∏–∫–æ–Ω–æ–≤—ã–µ –Ω–∞—Å–µ—á–∫–∏\n\nüì¶ –ö–æ–º–ø–ª–µ–∫—Ç–∞—Ü–∏—è:\n1. –ü–µ—Ä—á–∞—Ç–∫–∏ Nike\n2. –§–∏—Ä–º–µ–Ω–Ω—ã–π 3D —Å—Ç–∏–∫–µ—Ä\n3. –ë—Ä–µ–Ω–¥–æ–≤—ã–µ –Ω–æ—Å–∫–∏ Nike"}
];
const CATS=[{id:"all",name:"üè™ –í—Å–µ"},{id:"electronics",name:"üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞"},{id:"clothes",name:"üëï –û–¥–µ–∂–¥–∞"},{id:"home",name:"üè† –î–æ–º"},{id:"other",name:"üì¶ –î—Ä—É–≥–æ–µ"}];

let cart=JSON.parse(localStorage.getItem('cart')||'[]');
let favs=JSON.parse(localStorage.getItem('favs')||'[]');
let curCat='all';
let curImgIdx=0;
let modalQty=1;
let userId=null;
let userDiscount={total:0,referral:0,admin:0,promo:0,promo_code:null,referral_count:0};

async function init(){
    if(tg){
        tg.expand();
        tg.enableClosingConfirmation();
        userId=tg.initDataUnsafe?.user?.id;
        if(tg.colorScheme==='light')document.body.classList.add('light-theme');
        tg.onEvent('themeChanged',()=>{
            if(tg.colorScheme==='light')document.body.classList.add('light-theme');
            else document.body.classList.remove('light-theme');
        });
    }
    if(localStorage.getItem('theme')==='light')document.body.classList.add('light-theme');
    if(userId)await loadUserDiscount();
    renderCats();
    renderProds();
    updateCart();
    updateFav();
    setTimeout(()=>document.getElementById('loader').classList.add('hidden'),500);
}

async function loadUserDiscount(){
    try{
        const resp=await fetch(`${API_URL}/api/user/${userId}`);
        if(resp.ok){
            const data=await resp.json();
            if(data.discount){
                userDiscount=data.discount;
                updateDiscountBadge();
            }
        }
    }catch(e){console.log('API not available')}
}

function updateDiscountBadge(){
    const badge=document.getElementById('user-discount');
    const value=document.getElementById('discount-value');
    if(userDiscount.total>0){
        badge.style.display='inline-flex';
        value.textContent=userDiscount.total;
        if(userDiscount.promo_code){
            badge.classList.add('has-promo');
        }else{
            badge.classList.remove('has-promo');
        }
    }else{
        badge.style.display='none';
    }
}

function showDiscountDetails(){
    const modal=document.getElementById('discount-modal');
    const box=document.getElementById('discount-details-box');
    box.innerHTML=`
        <button class="modal-close" onclick="closeDiscountModal()">√ó</button>
        <div class="discount-details-title">üéÅ –í–∞—à–∏ —Å–∫–∏–¥–∫–∏</div>
        <div class="discount-detail-item ${userDiscount.referral>0?'active':''}">
            <div class="discount-detail-label">üë• –û—Ç —Ä–µ—Ñ–µ—Ä–∞–ª–æ–≤ (${userDiscount.referral_count||0} –¥—Ä—É–∑–µ–π)</div>
            <div class="discount-detail-value">${userDiscount.referral}%</div>
        </div>
        <div class="discount-detail-item ${userDiscount.admin>0?'active':''}">
            <div class="discount-detail-label">‚≠ê –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</div>
            <div class="discount-detail-value">${userDiscount.admin}%</div>
        </div>
        <div class="discount-detail-item ${userDiscount.promo>0?'active':''}">
            <div class="discount-detail-label">üéü –ü—Ä–æ–º–æ–∫–æ–¥ ${userDiscount.promo_code?`(${userDiscount.promo_code})`:''}</div>
            <div class="discount-detail-value">${userDiscount.promo}%</div>
        </div>
        <div class="discount-detail-item active" style="margin-top:16px;background:var(--green)">
            <div class="discount-detail-label">üí∞ –ò—Ç–æ–≥–æ</div>
            <div class="discount-detail-value" style="color:#fff">${userDiscount.total}%</div>
        </div>
        <p style="text-align:center;margin-top:16px;color:var(--hint);font-size:12px">
            –ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –¥–ª—è —É–≤–µ–ª–∏—á–µ–Ω–∏—è —Å–∫–∏–¥–∫–∏!<br>
            –ü—Ä–æ–º–æ–∫–æ–¥—ã –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω–µ.
        </p>
    `;
    modal.classList.add('active');
    haptic('light');
}

function closeDiscountModal(){document.getElementById('discount-modal').classList.remove('active')}

function haptic(t){if(tg?.HapticFeedback)tg.HapticFeedback.impactOccurred(t)}

function toggleTheme(){
    document.body.classList.toggle('light-theme');
    localStorage.setItem('theme',document.body.classList.contains('light-theme')?'light':'dark');
    haptic('light');
}

function renderCats(){
    const c=document.getElementById('categories');
    c.innerHTML=CATS.map(x=>`<button class="cat-btn ${x.id===curCat?'active':''}" onclick="setCat('${x.id}')">${x.name}</button>`).join('');
}

function setCat(id){curCat=id;renderCats();renderProds();haptic('light')}

function calcPrice(price){
    if(userDiscount.total>0)return Math.round(price*(1-userDiscount.total/100));
    return price;
}

function renderProds(){
    const s=document.getElementById('search').value.toLowerCase();
    const p=document.getElementById('products');
    let items=PRODUCTS;
    if(curCat!=='all')items=items.filter(x=>x.category===curCat);
    if(s)items=items.filter(x=>x.name.toLowerCase().includes(s));
    if(!items.length){
        p.innerHTML='<div class="empty-state"><div class="empty-state-icon">üîç</div><p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>';
        return;
    }
    p.innerHTML=items.map((x,i)=>{
        const isF=favs.includes(x.id);
        const finalPrice=calcPrice(x.price);
        const hasDiscount=userDiscount.total>0;
        return `<div class="product" style="animation-delay:${i*0.05}s" onclick="openProd(${x.id})">
            <button class="product-favorite ${isF?'active':''}" onclick="event.stopPropagation();toggleFav(${x.id})">${isF?'‚ù§Ô∏è':'ü§ç'}</button>
            <img class="product-img" src="${x.image}" alt="${x.name}" loading="lazy">
            <div class="product-name">${x.name}</div>
            <div class="product-price ${hasDiscount?'discounted':''}">
                ${hasDiscount?`<span class="old">${x.price}‚ÇΩ</span>`:''} ${finalPrice}‚ÇΩ
            </div>
        </div>`;
    }).join('');
}

function openProd(id){
    const x=PRODUCTS.find(p=>p.id===id);
    if(!x)return;
    curImgIdx=0;
    modalQty=1;
    const m=document.getElementById('modal');
    const b=document.getElementById('modal-box');
    const imgs=x.images||[x.image];
    const finalPrice=calcPrice(x.price);
    const savings=x.price-finalPrice;
    const hasDiscount=userDiscount.total>0;
    b.innerHTML=`
        <button class="modal-close" onclick="closeModal()">√ó</button>
        <div class="modal-gallery">
            ${imgs.length>1?`<button class="gallery-nav prev" onclick="navGal(-1,${id})">‚Äπ</button><button class="gallery-nav next" onclick="navGal(1,${id})">‚Ä∫</button>`:''}
            <img class="modal-img" id="m-img" src="${imgs[0]}" onclick="openFs(${id})">
        </div>
        <div class="modal-name">${x.name}</div>
        <div class="modal-desc">${x.description}</div>
        <div class="modal-price-box">
            ${hasDiscount?`<div class="old">${x.price}‚ÇΩ</div>`:''}
            <div class="new">${finalPrice}‚ÇΩ</div>
            ${hasDiscount?`<div class="discount-info">–≠–∫–æ–Ω–æ–º–∏—è ${savings}‚ÇΩ (—Å–∫–∏–¥–∫–∞ ${userDiscount.total}%)</div>`:''}
        </div>
        <div class="qty-controls">
            <button class="qty-btn" onclick="changeQty(-1)">‚àí</button>
            <span class="qty-value" id="qty-value">1</span>
            <button class="qty-btn" onclick="changeQty(1)">+</button>
        </div>
        <div class="modal-btns">
            <button class="btn btn-cart" onclick="addToCartFromModal(${x.id})">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button>
            <button class="btn btn-buy" onclick="buyNow(${x.id})">‚ö° –ö—É–ø–∏—Ç—å</button>
        </div>`;
    m.classList.add('active');
    haptic('light');
}

function changeQty(d){
    modalQty=Math.max(1,Math.min(99,modalQty+d));
    document.getElementById('qty-value').textContent=modalQty;
    haptic('light');
}

function navGal(d,id){
    const x=PRODUCTS.find(p=>p.id===id);
    const imgs=x.images||[x.image];
    curImgIdx=(curImgIdx+d+imgs.length)%imgs.length;
    document.getElementById('m-img').src=imgs[curImgIdx];
    haptic('light');
}

function closeModal(){document.getElementById('modal').classList.remove('active');modalQty=1}

function openFs(id){
    const x=PRODUCTS.find(p=>p.id===id);
    const imgs=x.images||[x.image];
    document.getElementById('fs-img').src=imgs[curImgIdx];
    document.getElementById('fs-counter').textContent=`${curImgIdx+1}/${imgs.length}`;
    document.getElementById('fullscreen-viewer').classList.add('active');
    haptic('light');
}

function closeFullscreen(){document.getElementById('fullscreen-viewer').classList.remove('active')}

function toggleFav(id){
    const i=favs.indexOf(id);
    if(i>-1)favs.splice(i,1);
    else favs.push(id);
    localStorage.setItem('favs',JSON.stringify(favs));
    updateFav();
    renderProds();
    haptic('light');
}

function updateFav(){
    const c=document.getElementById('fav-count');
    c.style.display=favs.length?'flex':'none';
    c.textContent=favs.length;
}

function openFavorites(){
    if(!favs.length){showToast('‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ');return}
    curCat='all';
    document.getElementById('search').value='';
    const p=document.getElementById('products');
    const items=PRODUCTS.filter(x=>favs.includes(x.id));
    p.innerHTML=items.map((x,i)=>{
        const finalPrice=calcPrice(x.price);
        return `<div class="product" style="animation-delay:${i*0.05}s" onclick="openProd(${x.id})">
            <button class="product-favorite active" onclick="event.stopPropagation();toggleFav(${x.id})">‚ù§Ô∏è</button>
            <img class="product-img" src="${x.image}" alt="${x.name}">
            <div class="product-name">${x.name}</div>
            <div class="product-price">${finalPrice}‚ÇΩ</div>
        </div>`;
    }).join('');
    haptic('light');
}

function addToCart(id,qty=1){
    const x=cart.find(p=>p.id===id);
    if(x)x.q+=qty;
    else cart.push({id,q:qty});
    localStorage.setItem('cart',JSON.stringify(cart));
    updateCart();
    showToast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');
    haptic('success');
}

function addToCartFromModal(id){
    addToCart(id,modalQty);
    closeModal();
}

function buyNow(id){
    cart=[{id,q:modalQty}];
    localStorage.setItem('cart',JSON.stringify(cart));
    updateCart();
    closeModal();
    openCart();
}

function updateCart(){
    const b=document.getElementById('cart-btn');
    const c=document.getElementById('cart-count');
    const s=document.getElementById('cart-sum');
    const total=cart.reduce((a,x)=>{
        const p=PRODUCTS.find(i=>i.id===x.id);
        if(!p)return a;
        return a+calcPrice(p.price)*x.q;
    },0);
    const count=cart.reduce((a,x)=>a+x.q,0);
    if(count){
        b.style.display='flex';
        c.textContent=count;
        s.textContent=total+'‚ÇΩ';
    }else b.style.display='none';
}

function openCart(){
    if(!cart.length){showToast('üõí –ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞');return}
    renderCart();
    document.getElementById('cart-modal').classList.add('active');
    haptic('light');
}

function renderCart(){
    const b=document.getElementById('cart-box');
    let itemsHtml=cart.map(x=>{
        const p=PRODUCTS.find(i=>i.id===x.id);
        if(!p)return '';
        const price=calcPrice(p.price);
        return `<div class="cart-item">
            <button class="cart-item-remove" onclick="removeFromCart(${x.id})">√ó</button>
            <img src="${p.image}" alt="${p.name}">
            <div class="cart-item-info">
                <div class="cart-item-name">${p.name}</div>
                <div class="cart-item-price">${price}‚ÇΩ √ó ${x.q} = ${price*x.q}‚ÇΩ</div>
            </div>
            <div class="cart-item-qty">
                <button onclick="updateCartQty(${x.id},-1)">‚àí</button>
                <span>${x.q}</span>
                <button onclick="updateCartQty(${x.id},1)">+</button>
            </div>
        </div>`;
    }).join('');
    
    const subtotal=cart.reduce((a,x)=>{
        const p=PRODUCTS.find(i=>i.id===x.id);
        return a+(p?p.price*x.q:0);
    },0);
    const total=cart.reduce((a,x)=>{
        const p=PRODUCTS.find(i=>i.id===x.id);
        if(!p)return a;
        return a+calcPrice(p.price)*x.q;
    },0);
    const savings=subtotal-total;
    
    let promoHtml='';
    if(userId){
        promoHtml=`
        <div class="promo-section">
            <div class="promo-title">üéü –ü—Ä–æ–º–æ–∫–æ–¥</div>
            ${userDiscount.promo_code?`
                <div class="promo-applied">
                    <span class="promo-applied-text">‚úÖ ${userDiscount.promo_code} (‚àí${userDiscount.promo}%)</span>
                    <button class="promo-remove-btn" onclick="removePromo()">√ó</button>
                </div>
            `:`
                <div class="promo-input-row">
                    <input type="text" class="promo-input" id="promo-input" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥">
                    <button class="promo-apply-btn" onclick="applyPromo()">OK</button>
                </div>
                <div class="promo-error" id="promo-error"></div>
            `}
            ${userDiscount.total>0?`
                <div class="discount-breakdown">
                    <div class="discount-row ${userDiscount.referral>0?'active':''}">
                        <span>üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è</span><span>${userDiscount.referral}%</span>
                    </div>
                    <div class="discount-row ${userDiscount.admin>0?'active':''}">
                        <span>‚≠ê –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</span><span>${userDiscount.admin}%</span>
                    </div>
                    <div class="discount-row ${userDiscount.promo>0?'active':''}">
                        <span>üéü –ü—Ä–æ–º–æ–∫–æ–¥</span><span>${userDiscount.promo}%</span>
                    </div>
                </div>
            `:''}
        </div>`;
    }
    
    b.innerHTML=`
        <button class="modal-close" onclick="closeCart()">√ó</button>
        <h2 style="margin-bottom:16px">üõí –ö–æ—Ä–∑–∏–Ω–∞</h2>
        ${itemsHtml}
        ${promoHtml}
        <div class="cart-summary">
            <div class="cart-row"><span>–¢–æ–≤–∞—Ä—ã (${cart.reduce((a,x)=>a+x.q,0)} —à—Ç.):</span><span>${subtotal}‚ÇΩ</span></div>
            ${savings>0?`<div class="cart-row discount"><span>üéÅ –°–∫–∏–¥–∫–∞ ${userDiscount.total}%:</span><span>‚àí${savings}‚ÇΩ</span></div>`:''}
            <div class="cart-row total"><span>–ò—Ç–æ–≥–æ:</span><span>${total}‚ÇΩ</span></div>
        </div>
        <button class="cart-checkout" onclick="checkout()">üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</button>`;
}

function closeCart(){document.getElementById('cart-modal').classList.remove('active')}

function updateCartQty(id,d){
    const x=cart.find(p=>p.id===id);
    if(x){
        x.q+=d;
        if(x.q<=0)cart=cart.filter(p=>p.id!==id);
    }
    localStorage.setItem('cart',JSON.stringify(cart));
    updateCart();
    if(cart.length)renderCart();
    else closeCart();
    haptic('light');
}

function removeFromCart(id){
    cart=cart.filter(x=>x.id!==id);
    localStorage.setItem('cart',JSON.stringify(cart));
    updateCart();
    if(cart.length)renderCart();
    else closeCart();
    haptic('light');
}

async function applyPromo(){
    const input=document.getElementById('promo-input');
    const error=document.getElementById('promo-error');
    const code=input.value.trim().toUpperCase();
    if(!code){error.textContent='–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';return}
    if(!userId){error.textContent='–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram';return}
    
    try{
        const resp=await fetch(`${API_URL}/api/promo/apply`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:userId,code:code})
        });
        const data=await resp.json();
        if(data.success){
            userDiscount=data.discount_info;
            updateDiscountBadge();
            renderProds();
            renderCart();
            updateCart();
            showToast(`‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ ${code} –ø—Ä–∏–º–µ–Ω—ë–Ω!`);
            haptic('success');
        }else{
            error.textContent=data.error||'–û—à–∏–±–∫–∞';
            haptic('error');
        }
    }catch(e){
        error.textContent='–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞';
        haptic('error');
    }
}

async function removePromo(){
    if(!userId)return;
    try{
        const resp=await fetch(`${API_URL}/api/promo/remove`,{
            method:'POST',
            headers:{'Content-Type':'application/json'},
            body:JSON.stringify({user_id:userId})
        });
        const data=await resp.json();
        if(data.success){
            userDiscount=data.discount_info;
            updateDiscountBadge();
            renderProds();
            renderCart();
            updateCart();
            showToast('üéü –ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω');
            haptic('light');
        }
    }catch(e){showToast('‚ùå –û—à–∏–±–∫–∞')}
}

function checkout(){
    if(!cart.length)return;
    
    const subtotal=cart.reduce((a,x)=>{
        const p=PRODUCTS.find(i=>i.id===x.id);
        return a+(p?p.price*x.q:0);
    },0);
    const total=cart.reduce((a,x)=>{
        const p=PRODUCTS.find(i=>i.id===x.id);
        if(!p)return a;
        return a+calcPrice(p.price)*x.q;
    },0);
    
    const items=cart.map(x=>{
        const p=PRODUCTS.find(i=>i.id===x.id);
        return {id:x.id,name:p.name,qty:x.q,price:calcPrice(p.price),original_price:p.price};
    });
    
    const orderData={
        action:'order',
        items:items,
        total:subtotal,
        discount:userDiscount.total,
        final_price:total,
        promo_code:userDiscount.promo_code,
        timestamp:Date.now()
    };
    
    if(tg&&tg.sendData){
        tg.sendData(JSON.stringify(orderData));
        cart=[];
        localStorage.setItem('cart','[]');
        closeCart();
        updateCart();
        confetti();
        showToast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');
        haptic('success');
        setTimeout(()=>tg.close(),2000);
    }else{
        const text=`–ó–¥—Ä–∞–≤—Å—Ç–≤—É–π—Ç–µ! –•–æ—á—É –∑–∞–∫–∞–∑–∞—Ç—å:\n\n${items.map((x,i)=>`${i+1}. ${x.name}\n   ${x.qty} —à—Ç √ó ${x.price}‚ÇΩ = ${x.qty*x.price}‚ÇΩ`).join('\n\n')}\n\n${userDiscount.total>0?`–°–∫–∏–¥–∫–∞: ${userDiscount.total}%\n`:''}–ò—Ç–æ–≥–æ: ${total}‚ÇΩ`;
        window.open(`https://t.me/SaturnKC?text=${encodeURIComponent(text)}`,'_blank');
        cart=[];
        localStorage.setItem('cart','[]');
        closeCart();
        updateCart();
    }
}

function showToast(m){
    const t=document.createElement('div');
    t.className='toast';
    t.textContent=m;
    document.body.appendChild(t);
    setTimeout(()=>t.remove(),2000);
}

function confetti(){
    const colors=['#ff6b6b','#4ade80','#667eea','#f59e0b','#ec4899'];
    for(let i=0;i<50;i++){
        const c=document.createElement('div');
        c.className='confetti';
        c.style.left=Math.random()*100+'vw';
        c.style.background=colors[Math.floor(Math.random()*colors.length)];
        c.style.animationDuration=(Math.random()*2+2)+'s';
        c.style.animationDelay=Math.random()*0.5+'s';
        document.body.appendChild(c);
        setTimeout(()=>c.remove(),4000);
    }
}

document.getElementById('search').addEventListener('input',renderProds);
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>

<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Premium Shop</title>
<script src="https://telegram.org/js/telegram-web-app.js"></script>
<style>
:root{
--bg:#0f0f1a;--bg2:#1a1a2e;--bg3:#252542;
--text:#fff;--hint:#888;
--accent:#667eea;--accent2:#764ba2;
--green:#22c55e;--red:#ff6b6b;--orange:#f59e0b;--blue:#3b82f6;
--shadow:0 4px 20px rgba(0,0,0,.3);
--radius:16px;--radius-sm:12px;--radius-xs:8px;
}
body.light{
--bg:#f5f5f7;--bg2:#fff;--bg3:#e5e5e5;
--text:#1a1a2e;--hint:#666;
}
*{margin:0;padding:0;box-sizing:border-box}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;padding-bottom:100px;transition:background .3s,color .3s}
@keyframes fadeIn{from{opacity:0}to{opacity:1}}
@keyframes fadeUp{from{opacity:0;transform:translateY(20px)}to{opacity:1;transform:translateY(0)}}
@keyframes fadeDown{from{opacity:0;transform:translateY(-20px)}to{opacity:1;transform:translateY(0)}}
@keyframes scaleIn{from{opacity:0;transform:scale(.9)}to{opacity:1;transform:scale(1)}}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:translateY(0)}}
@keyframes slideRight{from{transform:translateX(-100%)}to{transform:translateX(0)}}
@keyframes pulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
@keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
@keyframes shimmer{0%{background-position:-200% 0}100%{background-position:200% 0}}
@keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
@keyframes spin{to{transform:rotate(360deg)}}
@keyframes ripple{to{transform:scale(4);opacity:0}}
@keyframes heartbeat{0%{transform:scale(1)}14%{transform:scale(1.3)}28%{transform:scale(1)}42%{transform:scale(1.3)}70%{transform:scale(1)}}
@keyframes confetti{0%{transform:translateY(0) rotate(0)}100%{transform:translateY(100vh) rotate(720deg);opacity:0}}
.fade-in{animation:fadeIn .3s ease}
.fade-up{animation:fadeUp .4s ease}
.scale-in{animation:scaleIn .3s ease}
.loader{position:fixed;top:0;left:0;width:100%;height:100%;background:var(--bg);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:9999;gap:20px;animation:fadeIn .3s}
.loader.hidden{opacity:0;pointer-events:none;transition:opacity .5s}
.loader-spinner{width:60px;height:60px;border:4px solid var(--bg2);border-top-color:var(--accent);border-radius:50%;animation:spin 1s linear infinite}
.loader-text{color:var(--hint);font-size:14px;animation:pulse 1.5s infinite}
.skeleton{background:linear-gradient(90deg,var(--bg2) 25%,var(--bg3) 50%,var(--bg2) 75%);background-size:200% 100%;animation:shimmer 1.5s infinite;border-radius:var(--radius-xs)}
.skeleton-img{width:100%;height:120px;border-radius:var(--radius-sm);margin-bottom:10px}
.skeleton-text{height:14px;margin-bottom:8px;width:80%}
.skeleton-text.short{width:50%}
.skeleton-price{height:20px;width:40%}
.header{background:linear-gradient(135deg,var(--accent),var(--accent2));padding:20px;text-align:center;position:relative;overflow:hidden}
.header::before{content:'';position:absolute;top:-50%;left:-50%;width:200%;height:200%;background:linear-gradient(45deg,transparent 30%,rgba(255,255,255,.1) 50%,transparent 70%);animation:shimmer 3s infinite}
.header h1{font-size:22px;margin-bottom:4px;animation:fadeDown .5s}
.header p{font-size:13px;opacity:.9;animation:fadeDown .5s .1s backwards}
.header-btns{position:absolute;top:12px;right:12px;display:flex;gap:8px}
.header-btn{width:40px;height:40px;border:none;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;font-size:18px;transition:all .3s;backdrop-filter:blur(10px)}
.header-btn:active{transform:scale(.9)}
.fav-btn{position:absolute;top:12px;left:12px}
.fav-count{position:absolute;top:-4px;right:-4px;background:var(--red);width:18px;height:18px;border-radius:50%;font-size:10px;display:flex;align-items:center;justify-content:center;font-weight:700;animation:scaleIn .3s}
.disc-badge{background:linear-gradient(135deg,#4ade80,#22c55e);padding:8px 16px;border-radius:20px;font-size:12px;font-weight:600;display:inline-flex;align-items:center;gap:8px;margin-top:12px;cursor:pointer;transition:all .3s;animation:fadeUp .5s .2s backwards}
.disc-badge:active{transform:scale(.95)}
.disc-badge.promo{background:linear-gradient(135deg,var(--orange),#ea580c)}
.level-icon{font-size:16px}
.cats{display:flex;gap:10px;padding:16px 12px;overflow-x:auto;-webkit-overflow-scrolling:touch}
.cats::-webkit-scrollbar{display:none}
.cat{padding:12px 20px;border:none;border-radius:25px;background:var(--bg2);color:var(--text);font-size:13px;font-weight:500;white-space:nowrap;cursor:pointer;transition:all .3s;position:relative;overflow:hidden}
.cat::before{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.3);border-radius:50%;transform:translate(-50%,-50%);transition:width .5s,height .5s}
.cat:active::before{width:200px;height:200px}
.cat.active{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;box-shadow:0 4px 15px rgba(102,126,234,.4)}
.search{padding:0 12px 16px}
.search-box{position:relative}
.search-box input{width:100%;padding:14px 20px 14px 45px;border:2px solid transparent;border-radius:var(--radius);background:var(--bg2);color:var(--text);font-size:14px;outline:none;transition:all .3s}
.search-box input:focus{border-color:var(--accent);box-shadow:0 0 0 4px rgba(102,126,234,.2)}
.search-box::before{content:'üîç';position:absolute;left:16px;top:50%;transform:translateY(-50%);font-size:16px}
.products{display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:0 12px}
.product{background:var(--bg2);border-radius:var(--radius);padding:12px;cursor:pointer;position:relative;transition:all .3s;animation:fadeUp .5s backwards;overflow:hidden}
.product:nth-child(1){animation-delay:.05s}
.product:nth-child(2){animation-delay:.1s}
.product:nth-child(3){animation-delay:.15s}
.product:nth-child(4){animation-delay:.2s}
.product:active{transform:scale(.97)}
.product-fav{position:absolute;top:8px;right:8px;width:36px;height:36px;border:none;border-radius:50%;background:rgba(0,0,0,.5);color:#fff;cursor:pointer;display:flex;align-items:center;justify-content:center;z-index:2;font-size:16px;transition:all .3s;backdrop-filter:blur(8px)}
.product-fav.active{background:var(--red);animation:heartbeat .6s}
.product-badge{position:absolute;top:8px;left:8px;padding:5px 10px;border-radius:var(--radius-xs);font-size:10px;font-weight:700;z-index:2;animation:scaleIn .3s}
.product-badge.sale{background:var(--red);color:#fff}
.product-badge.new{background:var(--green);color:#fff}
.product-badge.hot{background:var(--orange);color:#fff}
.product-img{width:100%;height:130px;object-fit:cover;border-radius:var(--radius-sm);margin-bottom:10px;background:var(--bg3);transition:transform .3s}
.product:active .product-img{transform:scale(1.02)}
.product-colors{display:flex;gap:4px;margin-bottom:8px}
.product-color{width:16px;height:16px;border-radius:50%;border:2px solid var(--bg3)}
.product-name{font-size:13px;font-weight:600;margin-bottom:8px;line-height:1.4;min-height:36px;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.product-price{font-size:17px;font-weight:700;display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.product-price.has-disc{color:var(--green)}
.product-price .old{font-size:12px;color:var(--hint);text-decoration:line-through}
.empty{text-align:center;padding:60px 20px;color:var(--hint);animation:fadeIn .5s}
.empty-icon{font-size:70px;margin-bottom:16px;animation:bounce 2s infinite}
.cart-float{position:fixed;bottom:20px;left:16px;right:16px;background:linear-gradient(135deg,#4ade80,#22c55e);padding:16px 20px;border-radius:var(--radius);display:flex;justify-content:space-between;align-items:center;cursor:pointer;color:#fff;border:none;font-size:15px;font-weight:600;z-index:100;box-shadow:0 8px 30px rgba(34,197,94,.4);animation:fadeUp .5s;transition:all .3s}
.cart-float:active{transform:scale(.98)}
.cart-float.shake{animation:shake .5s}
.cart-count{background:#fff;color:var(--green);width:28px;height:28px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:13px;font-weight:700}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;z-index:1000}
.modal.active{display:flex;flex-direction:column;animation:fadeIn .2s}
.modal-bg{position:absolute;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(10px)}
.modal-content{position:absolute;bottom:0;left:0;right:0;background:var(--bg);border-radius:24px 24px 0 0;max-height:92vh;overflow-y:auto;animation:slideUp .3s ease-out}
.modal-header{position:sticky;top:0;background:var(--bg);padding:20px;border-bottom:1px solid var(--bg2);z-index:10;display:flex;align-items:center;justify-content:space-between}
.modal-title{font-size:18px;font-weight:700}
.modal-close{width:36px;height:36px;border:none;border-radius:50%;background:var(--bg2);color:var(--text);font-size:20px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all .3s}
.modal-close:active{transform:scale(.9);background:var(--bg3)}
.modal-body{padding:20px}
.gallery{position:relative;margin-bottom:20px}
.gallery-main{width:100%;height:300px;object-fit:cover;border-radius:var(--radius);background:var(--bg2)}
.gallery-nav{position:absolute;top:50%;transform:translateY(-50%);width:40px;height:40px;border:none;border-radius:50%;background:rgba(0,0,0,.6);color:#fff;cursor:pointer;font-size:18px;transition:all .2s;backdrop-filter:blur(5px)}
.gallery-nav:active{transform:translateY(-50%) scale(.9)}
.gallery-nav.prev{left:10px}
.gallery-nav.next{right:10px}
.gallery-dots{display:flex;justify-content:center;gap:8px;margin-top:12px}
.gallery-dot{width:8px;height:8px;border-radius:50%;background:var(--bg3);transition:all .3s;cursor:pointer}
.gallery-dot.active{background:var(--accent);width:24px}
.gallery-thumbs{display:flex;gap:8px;margin-top:12px;overflow-x:auto;padding-bottom:4px}
.gallery-thumb{width:60px;height:60px;border-radius:var(--radius-xs);object-fit:cover;cursor:pointer;opacity:.6;transition:all .3s;border:2px solid transparent;flex-shrink:0}
.gallery-thumb.active{opacity:1;border-color:var(--accent)}
.color-section{margin:16px 0}
.color-title{font-size:14px;font-weight:600;margin-bottom:10px;display:flex;align-items:center;gap:8px}
.color-title span{color:var(--hint);font-weight:400}
.color-options{display:flex;gap:10px;flex-wrap:wrap}
.color-opt{width:40px;height:40px;border-radius:50%;cursor:pointer;border:3px solid transparent;transition:all .3s;position:relative}
.color-opt:active{transform:scale(.9)}
.color-opt.active{border-color:var(--accent);box-shadow:0 0 0 3px rgba(102,126,234,.3)}
.color-opt.active::after{content:'‚úì';position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);color:#fff;font-size:16px;font-weight:700;text-shadow:0 1px 2px rgba(0,0,0,.5)}
.price-card{background:linear-gradient(135deg,var(--accent),var(--accent2));border-radius:var(--radius);padding:24px;text-align:center;margin:20px 0;position:relative;overflow:hidden}
.price-card::before{content:'';position:absolute;top:-50%;right:-50%;width:100%;height:100%;background:radial-gradient(circle,rgba(255,255,255,.1) 0%,transparent 70%)}
.price-old{font-size:16px;text-decoration:line-through;opacity:.7}
.price-new{font-size:36px;font-weight:700}
.price-save{font-size:13px;opacity:.9;margin-top:6px}
.price-save span{background:rgba(255,255,255,.2);padding:4px 12px;border-radius:20px}
.disc-card{background:var(--bg2);border-radius:var(--radius-sm);padding:16px;margin:16px 0}
.disc-card-title{font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.disc-row{display:flex;justify-content:space-between;padding:8px 0;border-bottom:1px solid var(--bg3);font-size:13px;color:var(--hint)}
.disc-row:last-child{border-bottom:none}
.disc-row.active{color:var(--green)}
.disc-row .val{font-weight:600}
.qty-section{display:flex;align-items:center;justify-content:center;gap:20px;margin:20px 0;padding:16px;background:var(--bg2);border-radius:var(--radius-sm)}
.qty-btn{width:48px;height:48px;border:none;border-radius:50%;background:var(--bg3);color:var(--text);font-size:24px;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center}
.qty-btn:active{transform:scale(.9);background:var(--accent);color:#fff}
.qty-btn:disabled{opacity:.3;cursor:not-allowed}
.qty-val{font-size:28px;font-weight:700;min-width:50px;text-align:center}
.action-btns{display:flex;gap:12px;margin-top:20px}
.action-btn{flex:1;padding:18px;border:none;border-radius:var(--radius-sm);font-size:15px;font-weight:600;cursor:pointer;transition:all .2s;position:relative;overflow:hidden}
.action-btn::after{content:'';position:absolute;top:50%;left:50%;width:0;height:0;background:rgba(255,255,255,.3);border-radius:50%;transform:translate(-50%,-50%);transition:width .4s,height .4s}
.action-btn:active::after{width:300px;height:300px}
.action-btn:active{transform:scale(.98)}
.btn-secondary{background:var(--bg2);color:var(--text)}
.btn-primary{background:linear-gradient(135deg,#4ade80,#22c55e);color:#fff}
.btn-accent{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff}
.cart-empty{text-align:center;padding:60px 20px}
.cart-empty-icon{font-size:80px;margin-bottom:20px;animation:bounce 2s infinite}
.cart-empty-text{color:var(--hint);margin-bottom:20px}
.cart-item{display:flex;gap:12px;background:var(--bg2);border-radius:var(--radius-sm);padding:12px;margin-bottom:12px;position:relative;animation:fadeUp .3s}
.cart-item.removing{animation:fadeOut .3s forwards}
@keyframes fadeOut{to{opacity:0;transform:translateX(100px)}}
.cart-item-img{width:80px;height:80px;border-radius:var(--radius-xs);object-fit:cover;background:var(--bg3)}
.cart-item-info{flex:1;display:flex;flex-direction:column;justify-content:space-between}
.cart-item-name{font-size:14px;font-weight:600;line-height:1.3;display:-webkit-box;-webkit-line-clamp:2;-webkit-box-orient:vertical;overflow:hidden}
.cart-item-meta{font-size:12px;color:var(--hint)}
.cart-item-bottom{display:flex;align-items:center;justify-content:space-between}
.cart-item-price{font-size:16px;font-weight:700;color:var(--green)}
.cart-item-qty{display:flex;align-items:center;gap:8px}
.cart-item-qty button{width:32px;height:32px;border:none;border-radius:50%;background:var(--bg3);color:var(--text);font-size:16px;cursor:pointer;transition:all .2s}
.cart-item-qty button:active{background:var(--accent);color:#fff;transform:scale(.9)}
.cart-item-qty span{font-weight:600;min-width:24px;text-align:center}
.cart-item-del{position:absolute;top:8px;right:8px;width:28px;height:28px;border:none;border-radius:50%;background:rgba(255,107,107,.1);color:var(--red);cursor:pointer;font-size:14px;transition:all .2s}
.cart-item-del:active{background:var(--red);color:#fff;transform:scale(.9)}
.promo-section{background:var(--bg2);border-radius:var(--radius-sm);padding:16px;margin-top:16px}
.promo-title{font-size:14px;font-weight:600;margin-bottom:12px;display:flex;align-items:center;gap:8px}
.promo-form{display:flex;gap:8px}
.promo-input{flex:1;padding:14px 16px;border:2px solid transparent;border-radius:var(--radius-xs);background:var(--bg);color:var(--text);font-size:14px;text-transform:uppercase;transition:all .3s}
.promo-input:focus{outline:none;border-color:var(--accent)}
.promo-input.error{border-color:var(--red);animation:shake .3s}
.promo-input.success{border-color:var(--green)}
.promo-btn{padding:14px 24px;border:none;border-radius:var(--radius-xs);background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;font-weight:600;cursor:pointer;transition:all .2s}
.promo-btn:active{transform:scale(.95)}
.promo-btn:disabled{opacity:.5;cursor:not-allowed}
.promo-msg{font-size:12px;margin-top:8px}
.promo-msg.error{color:var(--red)}
.promo-msg.success{color:var(--green)}
.promo-applied{display:flex;align-items:center;justify-content:space-between;background:linear-gradient(135deg,#4ade80,#22c55e);padding:12px 16px;border-radius:var(--radius-xs);margin-top:12px;animation:scaleIn .3s}
.promo-applied-text{font-size:13px;font-weight:600}
.promo-applied-del{width:28px;height:28px;border:none;border-radius:50%;background:rgba(255,255,255,.2);color:#fff;cursor:pointer;font-size:14px;transition:all .2s}
.promo-applied-del:active{transform:scale(.9)}
.cart-summary{margin-top:20px;padding-top:20px;border-top:1px solid var(--bg2)}
.summary-row{display:flex;justify-content:space-between;margin-bottom:12px;font-size:14px;color:var(--hint)}
.summary-row.discount{color:var(--green)}
.summary-row.total{font-size:20px;font-weight:700;color:var(--text);margin-top:16px;padding-top:16px;border-top:2px dashed var(--bg2)}
.checkout-btn{width:100%;padding:18px;border:none;border-radius:var(--radius);background:linear-gradient(135deg,#4ade80,#22c55e);color:#fff;font-size:16px;font-weight:700;cursor:pointer;margin-top:20px;transition:all .2s;position:relative;overflow:hidden}
.checkout-btn:active{transform:scale(.98)}
.checkout-btn:disabled{opacity:.5;cursor:not-allowed}
.checkout-btn .spinner{display:none;width:20px;height:20px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin 1s linear infinite}
.checkout-btn.loading .text{display:none}
.checkout-btn.loading .spinner{display:inline-block}
.faq-section{margin-top:24px}
.faq-title{font-size:16px;font-weight:700;margin-bottom:16px;display:flex;align-items:center;gap:8px}
.faq-item{background:var(--bg2);border-radius:var(--radius-sm);margin-bottom:8px;overflow:hidden}
.faq-q{padding:16px;font-size:14px;font-weight:600;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:background .2s}
.faq-q:active{background:var(--bg3)}
.faq-q-icon{font-size:12px;transition:transform .3s}
.faq-item.open .faq-q-icon{transform:rotate(180deg)}
.faq-a{max-height:0;overflow:hidden;transition:max-height .3s ease-out}
.faq-item.open .faq-a{max-height:200px}
.faq-a-inner{padding:0 16px 16px;font-size:13px;color:var(--hint);line-height:1.6}
.toast{position:fixed;bottom:100px;left:50%;transform:translateX(-50%);background:var(--bg2);color:var(--text);padding:14px 28px;border-radius:30px;z-index:2000;box-shadow:var(--shadow);animation:fadeUp .3s,fadeOut .3s 2s forwards;display:flex;align-items:center;gap:10px;font-size:14px;font-weight:500}
.toast-icon{font-size:18px}
.confetti{position:fixed;width:12px;height:12px;top:-20px;z-index:3000;animation:confetti 3s linear forwards;pointer-events:none;border-radius:2px}
</style>
</head>
<body>
<div class="loader" id="loader">
<div class="loader-spinner"></div>
<div class="loader-text">–ó–∞–≥—Ä—É–∂–∞–µ–º –º–∞–≥–∞–∑–∏–Ω...</div>
</div>
<header class="header">
<h1>üõç Premium Shop</h1>
<p>–õ—É—á—à–∏–µ —Ü–µ–Ω—ã –≤ –∏–Ω—Ç–µ—Ä–Ω–µ—Ç–µ!</p>
<div class="disc-badge" id="discBadge" style="display:none" onclick="openDiscountInfo()">
<span>üéÅ</span>
<span>–°–∫–∏–¥–∫–∞: <b id="discValue">0</b>%</span>
<span class="level-icon" id="levelIcon"></span>
</div>
<button class="header-btn fav-btn" onclick="openFavorites()">
‚ù§Ô∏è
<span class="fav-count" id="favCount" style="display:none">0</span>
</button>
<div class="header-btns">
<button class="header-btn" onclick="toggleTheme()">üåô</button>
</div>
</header>
<div class="cats" id="categories"></div>
<div class="search">
<div class="search-box">
<input type="text" id="searchInput" placeholder="–ù–∞–π—Ç–∏ —Ç–æ–≤–∞—Ä...">
</div>
</div>
<div class="products" id="products"></div>
<button class="cart-float" id="cartBtn" style="display:none" onclick="openCart()">
<span class="cart-count" id="cartCount">0</span>
<span>üõí –ö–æ—Ä–∑–∏–Ω–∞</span>
<span id="cartTotal">0 ‚ÇΩ</span>
</button>
<div class="modal" id="productModal">
<div class="modal-bg" onclick="closeProduct()"></div>
<div class="modal-content">
<div class="modal-header">
<span class="modal-title">–¢–æ–≤–∞—Ä</span>
<button class="modal-close" onclick="closeProduct()">√ó</button>
</div>
<div class="modal-body" id="productBody"></div>
</div>
</div>
<div class="modal" id="cartModal">
<div class="modal-bg" onclick="closeCart()"></div>
<div class="modal-content">
<div class="modal-header">
<span class="modal-title">üõí –ö–æ—Ä–∑–∏–Ω–∞</span>
<button class="modal-close" onclick="closeCart()">√ó</button>
</div>
<div class="modal-body" id="cartBody"></div>
</div>
</div>
<div class="modal" id="discModal">
<div class="modal-bg" onclick="closeDiscountInfo()"></div>
<div class="modal-content">
<div class="modal-header">
<span class="modal-title">üéÅ –í–∞—à–∏ —Å–∫–∏–¥–∫–∏</span>
<button class="modal-close" onclick="closeDiscountInfo()">√ó</button>
</div>
<div class="modal-body" id="discBody"></div>
</div>
</div>
<script>
const CONFIG={API:'http://79.141.215.184:8080',COLORS:{black:'#1a1a1a',white:'#f5f5f5',red:'#ef4444',blue:'#3b82f6',green:'#22c55e',yellow:'#eab308',pink:'#ec4899',purple:'#8b5cf6',orange:'#f97316',gray:'#6b7280'}};
const STATE={products:[],cart:JSON.parse(localStorage.getItem('cart')||'[]'),favs:JSON.parse(localStorage.getItem('favs')||'[]'),category:'all',user:null,discount:{total:0,referral:0,admin:0,promo:0,first_order:0,review:0,ref_level:'none',ref_count:0,promo_code:null,first_order_used:false},currentProduct:null,currentQty:1,currentColor:null,currentImg:0};
const tg=window.Telegram?.WebApp;
async function init(){if(tg){tg.expand();tg.enableClosingConfirmation();STATE.user=tg.initDataUnsafe?.user;if(tg.colorScheme==='light')document.body.classList.add('light')}if(localStorage.getItem('theme')==='light')document.body.classList.add('light');await Promise.all([loadProducts(),loadUserData()]);renderCategories();renderProducts();updateCartButton();updateFavButton();updateDiscountBadge();setTimeout(()=>{document.getElementById('loader').classList.add('hidden')},500);document.getElementById('searchInput').addEventListener('input',debounce(renderProducts,300))}
async function loadProducts(){try{const res=await fetch(`${CONFIG.API}/api/products`);if(res.ok){const data=await res.json();STATE.products=data.products||[]}}catch(e){console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–æ–≤–∞—Ä–æ–≤:',e)}}
async function loadUserData(){if(!STATE.user?.id)return;try{const res=await fetch(`${CONFIG.API}/api/user/${STATE.user.id}`);if(res.ok){const data=await res.json();if(data.discount)STATE.discount=data.discount}}catch(e){console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è:',e)}}
function renderCategories(){const cats=[{slug:'all',name:'üè™ –í—Å–µ'}];const seen=new Set(['all']);const catNames={clothes:'üëï –û–¥–µ–∂–¥–∞',electronics:'üì± –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞',shoes:'üëü –û–±—É–≤—å',accessories:'‚åö –ê–∫—Å–µ—Å—Å—É–∞—Ä—ã',other:'üì¶ –î—Ä—É–≥–æ–µ'};STATE.products.forEach(p=>{if(p.category&&!seen.has(p.category)){seen.add(p.category);cats.push({slug:p.category,name:catNames[p.category]||p.category})}});document.getElementById('categories').innerHTML=cats.map(c=>`<button class="cat ${c.slug===STATE.category?'active':''}" onclick="setCategory('${c.slug}')">${c.name}</button>`).join('')}
function setCategory(slug){STATE.category=slug;renderCategories();renderProducts();haptic('light')}
function renderProducts(){const container=document.getElementById('products');const search=document.getElementById('searchInput').value.toLowerCase();let items=STATE.products.filter(p=>p.is_active);if(STATE.category!=='all')items=items.filter(p=>p.category===STATE.category);if(search)items=items.filter(p=>p.name.toLowerCase().includes(search));if(!items.length){container.innerHTML=`<div class="empty" style="grid-column:1/-1"><div class="empty-icon">üîç</div><p>–¢–æ–≤–∞—Ä—ã –Ω–µ –Ω–∞–π–¥–µ–Ω—ã</p></div>`;return}container.innerHTML=items.map((p,i)=>{const prices=calcProductPrice(p);const isFav=STATE.favs.includes(p.id);const img=p.images?.[0]||'https://via.placeholder.com/200';let badge='';if(!STATE.discount.first_order_used&&p.first_order_discount>0){badge=`<div class="product-badge new">üéâ -${p.first_order_discount}%</div>`}else if(p.old_price>p.price){const off=Math.round((1-p.price/p.old_price)*100);badge=`<div class="product-badge sale">-${off}%</div>`}const colors=p.colors?p.colors.split(',').slice(0,4):[];const colorsHtml=colors.length?`<div class="product-colors">${colors.map(c=>`<div class="product-color" style="background:${CONFIG.COLORS[c.trim()]||c}"></div>`).join('')}</div>`:'';return`<div class="product" onclick="openProduct(${p.id})" style="animation-delay:${i*0.05}s"><button class="product-fav ${isFav?'active':''}" onclick="event.stopPropagation();toggleFavorite(${p.id})">${isFav?'‚ù§Ô∏è':'ü§ç'}</button>${badge}<img class="product-img" src="${img}" alt="${p.name}" loading="lazy">${colorsHtml}<div class="product-name">${p.name}</div><div class="product-price ${prices.discount>0?'has-disc':''}">${p.old_price?`<span class="old">${p.old_price} ‚ÇΩ</span>`:''}${prices.discount>0?`<span class="old">${p.price} ‚ÇΩ</span>`:''}${prices.final} ‚ÇΩ</div></div>`}).join('')}
function calcProductPrice(product){let disc=STATE.discount.total||0;if(!STATE.discount.first_order_used&&product.first_order_discount)disc+=product.first_order_discount;const level=STATE.discount.ref_level;if(level==='gold'&&product.ref_gold_discount)disc=Math.max(disc,product.ref_gold_discount);else if(level==='silver'&&product.ref_silver_discount)disc=Math.max(disc,product.ref_silver_discount);else if(level==='bronze'&&product.ref_bronze_discount)disc=Math.max(disc,product.ref_bronze_discount);disc=Math.min(disc,50);const final=Math.round(product.price*(1-disc/100));return{original:product.price,final,discount:disc,savings:product.price-final}}
function openProduct(id){const product=STATE.products.find(p=>p.id===id);if(!product)return;STATE.currentProduct=product;STATE.currentQty=1;STATE.currentImg=0;STATE.currentColor=product.colors?product.colors.split(',')[0].trim():null;renderProductModal();document.getElementById('productModal').classList.add('active');haptic('light')}
function renderProductModal(){const p=STATE.currentProduct;const prices=calcProductPrice(p);const imgs=p.images?.length?p.images:['https://via.placeholder.com/400'];const colors=p.colors?p.colors.split(',').map(c=>c.trim()):[];document.getElementById('productBody').innerHTML=`<div class="gallery">${imgs.length>1?`<button class="gallery-nav prev" onclick="navImage(-1)">‚Äπ</button><button class="gallery-nav next" onclick="navImage(1)">‚Ä∫</button>`:''}<img class="gallery-main" id="mainImg" src="${imgs[STATE.currentImg]}">${imgs.length>1?`<div class="gallery-dots">${imgs.map((_,i)=>`<div class="gallery-dot ${i===STATE.currentImg?'active':''}" onclick="setImage(${i})"></div>`).join('')}</div><div class="gallery-thumbs">${imgs.map((img,i)=>`<img class="gallery-thumb ${i===STATE.currentImg?'active':''}" src="${img}" onclick="setImage(${i})">`).join('')}</div>`:''}</div><h2 style="font-size:20px;margin-bottom:12px">${p.name}</h2><p style="color:var(--hint);font-size:14px;line-height:1.6;margin-bottom:16px;white-space:pre-wrap">${p.description||''}</p>${colors.length?`<div class="color-section"><div class="color-title">–¶–≤–µ—Ç: <span id="colorName">${STATE.currentColor}</span></div><div class="color-options">${colors.map(c=>`<div class="color-opt ${c===STATE.currentColor?'active':''}" style="background:${CONFIG.COLORS[c]||c}" onclick="selectColor('${c}')"></div>`).join('')}</div></div>`:''}<div class="price-card">${prices.discount>0?`<div class="price-old">${p.price} ‚ÇΩ</div>`:''}<div class="price-new">${prices.final} ‚ÇΩ</div>${prices.savings>0?`<div class="price-save"><span>–≠–∫–æ–Ω–æ–º–∏—è ${prices.savings} ‚ÇΩ (${prices.discount}%)</span></div>`:''}</div>${prices.discount>0?`<div class="disc-card"><div class="disc-card-title">üìä –î–µ—Ç–∞–ª–∏–∑–∞—Ü–∏—è —Å–∫–∏–¥–∫–∏</div><div class="disc-row ${STATE.discount.referral>0?'active':''}"><span>üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è</span><span class="val">${STATE.discount.referral}%</span></div><div class="disc-row ${!STATE.discount.first_order_used&&p.first_order_discount?'active':''}"><span>üéâ –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</span><span class="val">${p.first_order_discount||0}%</span></div><div class="disc-row ${STATE.discount.admin>0?'active':''}"><span>‚≠ê –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</span><span class="val">${STATE.discount.admin}%</span></div><div class="disc-row ${STATE.discount.review>0?'active':''}"><span>‚≠ê –ó–∞ –æ—Ç–∑—ã–≤—ã</span><span class="val">${STATE.discount.review}%</span></div><div class="disc-row ${STATE.discount.promo>0?'active':''}"><span>üéü –ü—Ä–æ–º–æ–∫–æ–¥</span><span class="val">${STATE.discount.promo}%</span></div></div>`:''}<div class="qty-section"><button class="qty-btn" onclick="changeQty(-1)" ${STATE.currentQty<=1?'disabled':''}>‚àí</button><span class="qty-val" id="qtyVal">${STATE.currentQty}</span><button class="qty-btn" onclick="changeQty(1)">+</button></div><div class="action-btns"><button class="action-btn btn-secondary" onclick="addToCart()">üõí –í –∫–æ—Ä–∑–∏–Ω—É</button><button class="action-btn btn-primary" onclick="buyNow()">‚ö° –ö—É–ø–∏—Ç—å</button></div><div class="faq-section"><div class="faq-title">‚ùì –í–æ–ø—Ä–æ—Å—ã –∏ –æ—Ç–≤–µ—Ç—ã</div><div class="faq-item" onclick="toggleFaq(this)"><div class="faq-q"><span>–ö–∞–∫ –æ—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑?</span><span class="faq-q-icon">‚ñº</span></div><div class="faq-a"><div class="faq-a-inner">–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–≤–∞—Ä –≤ –∫–æ—Ä–∑–∏–Ω—É, –Ω–∞–∂–º–∏—Ç–µ "–û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑" –∏ —Å–ª–µ–¥—É–π—Ç–µ –∏–Ω—Å—Ç—Ä—É–∫—Ü–∏—è–º. –ú–µ–Ω–µ–¥–∂–µ—Ä —Å–≤—è–∂–µ—Ç—Å—è —Å –≤–∞–º–∏ –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è.</div></div></div><div class="faq-item" onclick="toggleFaq(this)"><div class="faq-q"><span>–ö–∞–∫–∞—è –¥–æ—Å—Ç–∞–≤–∫–∞?</span><span class="faq-q-icon">‚ñº</span></div><div class="faq-a"><div class="faq-a-inner">–î–æ—Å—Ç–∞–≤–ª—è–µ–º –ø–æ –≤—Å–µ–π –†–æ—Å—Å–∏–∏: –ü–æ—á—Ç–∞, –°–î–≠–ö, Boxberry, –Ø–Ω–¥–µ–∫—Å –î–æ—Å—Ç–∞–≤–∫–∞. –°—Ä–æ–∫–∏ –æ—Ç 1 –¥–æ 14 –¥–Ω–µ–π.</div></div></div><div class="faq-item" onclick="toggleFaq(this)"><div class="faq-q"><span>–ö–∞–∫ –æ–ø–ª–∞—Ç–∏—Ç—å?</span><span class="faq-q-icon">‚ñº</span></div><div class="faq-a"><div class="faq-a-inner">–ü—Ä–∏–Ω–∏–º–∞–µ–º –∫–∞—Ä—Ç—ã, –°–ë–ü, –ø–µ—Ä–µ–≤–æ–¥—ã. –û–ø–ª–∞—Ç–∞ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.</div></div></div><div class="faq-item" onclick="toggleFaq(this)"><div class="faq-q"><span>–ú–æ–∂–Ω–æ –≤–µ—Ä–Ω—É—Ç—å —Ç–æ–≤–∞—Ä?</span><span class="faq-q-icon">‚ñº</span></div><div class="faq-a"><div class="faq-a-inner">–î–∞! –í–æ–∑–≤—Ä–∞—Ç –∏ –æ–±–º–µ–Ω –≤ —Ç–µ—á–µ–Ω–∏–µ 14 –¥–Ω–µ–π. –ë—Ä–∞–∫ –º–µ–Ω—è–µ–º –±–µ—Å–ø–ª–∞—Ç–Ω–æ. –°–≤—è–∂–∏—Ç–µ—Å—å —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π.</div></div></div></div>`}
function closeProduct(){document.getElementById('productModal').classList.remove('active');STATE.currentProduct=null}
function navImage(dir){const imgs=STATE.currentProduct.images||[];if(imgs.length<2)return;STATE.currentImg=(STATE.currentImg+dir+imgs.length)%imgs.length;updateGallery();haptic('light')}
function setImage(idx){STATE.currentImg=idx;updateGallery();haptic('light')}
function updateGallery(){const imgs=STATE.currentProduct.images||[];document.getElementById('mainImg').src=imgs[STATE.currentImg];document.querySelectorAll('.gallery-dot').forEach((dot,i)=>{dot.classList.toggle('active',i===STATE.currentImg)});document.querySelectorAll('.gallery-thumb').forEach((thumb,i)=>{thumb.classList.toggle('active',i===STATE.currentImg)})}
function selectColor(color){STATE.currentColor=color;document.getElementById('colorName').textContent=color;document.querySelectorAll('.color-opt').forEach(el=>{el.classList.toggle('active',el.style.background.includes(CONFIG.COLORS[color]||color))});haptic('light')}
function changeQty(delta){STATE.currentQty=Math.max(1,Math.min(99,STATE.currentQty+delta));document.getElementById('qtyVal').textContent=STATE.currentQty;document.querySelectorAll('.qty-btn')[0].disabled=STATE.currentQty<=1;haptic('light')}
function toggleFaq(el){el.classList.toggle('open');haptic('light')}
function addToCart(){const p=STATE.currentProduct;if(!p)return;const existing=STATE.cart.find(item=>item.id===p.id&&item.color===STATE.currentColor);if(existing){existing.qty+=STATE.currentQty}else{STATE.cart.push({id:p.id,qty:STATE.currentQty,color:STATE.currentColor})}saveCart();updateCartButton();closeProduct();document.getElementById('cartBtn').classList.add('shake');setTimeout(()=>document.getElementById('cartBtn').classList.remove('shake'),500);toast('‚úÖ –î–æ–±–∞–≤–ª–µ–Ω–æ –≤ –∫–æ—Ä–∑–∏–Ω—É');haptic('success')}
function buyNow(){STATE.cart=[{id:STATE.currentProduct.id,qty:STATE.currentQty,color:STATE.currentColor}];saveCart();updateCartButton();closeProduct();openCart()}
function openCart(){renderCart();document.getElementById('cartModal').classList.add('active');haptic('light')}
function closeCart(){document.getElementById('cartModal').classList.remove('active')}
function renderCart(){const body=document.getElementById('cartBody');if(!STATE.cart.length){body.innerHTML=`<div class="cart-empty"><div class="cart-empty-icon">üõí</div><p class="cart-empty-text">–ö–æ—Ä–∑–∏–Ω–∞ –ø—É—Å—Ç–∞</p><button class="action-btn btn-accent" onclick="closeCart()">–ó–∞ –ø–æ–∫—É–ø–∫–∞–º–∏!</button></div>`;return}let subtotal=0;let total=0;const itemsHtml=STATE.cart.map(item=>{const p=STATE.products.find(x=>x.id===item.id);if(!p)return'';const prices=calcProductPrice(p);const itemTotal=prices.final*item.qty;subtotal+=p.price*item.qty;total+=itemTotal;return`<div class="cart-item" id="cartItem${item.id}"><button class="cart-item-del" onclick="removeFromCart(${item.id},'${item.color}')">√ó</button><img class="cart-item-img" src="${p.images?.[0]||'https://via.placeholder.com/80'}"><div class="cart-item-info"><div class="cart-item-name">${p.name}</div>${item.color?`<div class="cart-item-meta">–¶–≤–µ—Ç: ${item.color}</div>`:''}<div class="cart-item-bottom"><span class="cart-item-price">${itemTotal} ‚ÇΩ</span><div class="cart-item-qty"><button onclick="updateCartQty(${item.id},'${item.color}',-1)">‚àí</button><span>${item.qty}</span><button onclick="updateCartQty(${item.id},'${item.color}',1)">+</button></div></div></div></div>`}).join('');const savings=subtotal-total;const discPercent=subtotal>0?Math.round((1-total/subtotal)*100):0;body.innerHTML=`${itemsHtml}<div class="promo-section"><div class="promo-title">üéü –ü—Ä–æ–º–æ–∫–æ–¥</div>${STATE.discount.promo_code?`<div class="promo-applied"><span class="promo-applied-text">‚úÖ ${STATE.discount.promo_code} (‚àí${STATE.discount.promo}%)</span><button class="promo-applied-del" onclick="removePromo()">√ó</button></div>`:`<div class="promo-form"><input type="text" class="promo-input" id="promoInput" placeholder="–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥"><button class="promo-btn" id="promoBtn" onclick="applyPromo()">OK</button></div><div class="promo-msg" id="promoMsg"></div>`}</div><div class="cart-summary"><div class="summary-row"><span>–¢–æ–≤–∞—Ä—ã (${STATE.cart.reduce((a,i)=>a+i.qty,0)} —à—Ç.)</span><span>${subtotal} ‚ÇΩ</span></div>${savings>0?`<div class="summary-row discount"><span>üéÅ –°–∫–∏–¥–∫–∞ ${discPercent}%</span><span>‚àí${savings} ‚ÇΩ</span></div>`:''}<div class="summary-row total"><span>–ò—Ç–æ–≥–æ</span><span>${total} ‚ÇΩ</span></div></div><button class="checkout-btn" onclick="checkout()"><span class="text">üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∑–∞–∫–∞–∑</span><span class="spinner"></span></button>`}
function updateCartQty(id,color,delta){const item=STATE.cart.find(i=>i.id===id&&i.color===color);if(!item)return;item.qty+=delta;if(item.qty<=0){removeFromCart(id,color);return}saveCart();renderCart();updateCartButton();haptic('light')}
function removeFromCart(id,color){const el=document.getElementById(`cartItem${id}`);if(el)el.classList.add('removing');setTimeout(()=>{STATE.cart=STATE.cart.filter(i=>!(i.id===id&&i.color===color));saveCart();renderCart();updateCartButton();if(!STATE.cart.length)closeCart()},300);haptic('light')}
function saveCart(){localStorage.setItem('cart',JSON.stringify(STATE.cart))}
function updateCartButton(){const btn=document.getElementById('cartBtn');const count=document.getElementById('cartCount');const total=document.getElementById('cartTotal');const qty=STATE.cart.reduce((a,i)=>a+i.qty,0);const sum=STATE.cart.reduce((a,i)=>{const p=STATE.products.find(x=>x.id===i.id);if(!p)return a;return a+calcProductPrice(p).final*i.qty},0);if(qty>0){btn.style.display='flex';count.textContent=qty;total.textContent=sum+' ‚ÇΩ'}else{btn.style.display='none'}}
async function applyPromo(){const input=document.getElementById('promoInput');const msg=document.getElementById('promoMsg');const btn=document.getElementById('promoBtn');const code=input.value.trim().toUpperCase();if(!code){input.classList.add('error');msg.className='promo-msg error';msg.textContent='–í–≤–µ–¥–∏—Ç–µ –ø—Ä–æ–º–æ–∫–æ–¥';setTimeout(()=>input.classList.remove('error'),300);return}if(!STATE.user?.id){msg.className='promo-msg error';msg.textContent='–û—Ç–∫—Ä–æ–π—Ç–µ —á–µ—Ä–µ–∑ Telegram';return}btn.disabled=true;btn.textContent='...';try{const res=await fetch(`${CONFIG.API}/api/promo/apply`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:STATE.user.id,code})});const data=await res.json();if(data.success){STATE.discount=data.discount_info;updateDiscountBadge();renderProducts();renderCart();updateCartButton();input.classList.add('success');toast('‚úÖ –ü—Ä–æ–º–æ–∫–æ–¥ –ø—Ä–∏–º–µ–Ω—ë–Ω!');haptic('success')}else{input.classList.add('error');msg.className='promo-msg error';msg.textContent=data.error||'–û—à–∏–±–∫–∞';setTimeout(()=>input.classList.remove('error'),300);haptic('error')}}catch(e){msg.className='promo-msg error';msg.textContent='–û—à–∏–±–∫–∞ —Å–µ—Ä–≤–µ—Ä–∞'}btn.disabled=false;btn.textContent='OK'}
async function removePromo(){if(!STATE.user?.id)return;try{const res=await fetch(`${CONFIG.API}/api/promo/remove`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({user_id:STATE.user.id})});const data=await res.json();if(data.success){STATE.discount=data.discount_info;updateDiscountBadge();renderProducts();renderCart();updateCartButton();toast('üéü –ü—Ä–æ–º–æ–∫–æ–¥ —É–¥–∞–ª—ë–Ω');haptic('light')}}catch(e){toast('‚ùå –û—à–∏–±–∫–∞')}}
async function checkout(){if(!STATE.cart.length)return;const btn=document.querySelector('.checkout-btn');btn.classList.add('loading');btn.disabled=true;let subtotal=0;let total=0;const discDetails={};const items=STATE.cart.map(item=>{const p=STATE.products.find(x=>x.id===item.id);if(!p)return null;const prices=calcProductPrice(p);subtotal+=p.price*item.qty;total+=prices.final*item.qty;return{id:item.id,name:p.name,qty:item.qty,color:item.color,price:prices.final,original:p.price}}).filter(Boolean);const discPercent=subtotal>0?Math.round((1-total/subtotal)*100):0;if(STATE.discount.referral>0)discDetails.referral=STATE.discount.referral;if(STATE.discount.admin>0)discDetails.admin=STATE.discount.admin;if(STATE.discount.promo>0)discDetails.promo=STATE.discount.promo;if(STATE.discount.review>0)discDetails.review=STATE.discount.review;const orderData={action:'order',items,total:subtotal,discount:discPercent,final_price:total,discount_details:discDetails,promo_code:STATE.discount.promo_code,timestamp:Date.now()};if(tg?.sendData){tg.sendData(JSON.stringify(orderData));STATE.cart=[];saveCart();closeCart();updateCartButton();confettiEffect();toast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!');haptic('success');setTimeout(()=>tg.close(),2000)}else{console.log('Order:',orderData);toast('‚úÖ –ó–∞–∫–∞–∑ –æ—Ñ–æ—Ä–º–ª–µ–Ω (—Ç–µ—Å—Ç)');STATE.cart=[];saveCart();closeCart();updateCartButton()}btn.classList.remove('loading');btn.disabled=false}
function toggleFavorite(id){const idx=STATE.favs.indexOf(id);if(idx>-1)STATE.favs.splice(idx,1);else STATE.favs.push(id);localStorage.setItem('favs',JSON.stringify(STATE.favs));updateFavButton();renderProducts();haptic('light')}
function updateFavButton(){const el=document.getElementById('favCount');if(STATE.favs.length>0){el.style.display='flex';el.textContent=STATE.favs.length}else{el.style.display='none'}}
function openFavorites(){if(!STATE.favs.length){toast('‚ù§Ô∏è –ò–∑–±—Ä–∞–Ω–Ω–æ–µ –ø—É—Å—Ç–æ');return}STATE.category='all';document.getElementById('searchInput').value='';const container=document.getElementById('products');const items=STATE.products.filter(p=>STATE.favs.includes(p.id));container.innerHTML=items.map(p=>{const prices=calcProductPrice(p);const img=p.images?.[0]||'';return`<div class="product" onclick="openProduct(${p.id})"><button class="product-fav active" onclick="event.stopPropagation();toggleFavorite(${p.id})">‚ù§Ô∏è</button><img class="product-img" src="${img}"><div class="product-name">${p.name}</div><div class="product-price has-disc">${prices.final} ‚ÇΩ</div></div>`}).join('');renderCategories();haptic('light')}
function updateDiscountBadge(){const badge=document.getElementById('discBadge');const val=document.getElementById('discValue');const icon=document.getElementById('levelIcon');if(STATE.discount.total>0||STATE.discount.ref_level!=='none'){badge.style.display='inline-flex';val.textContent=STATE.discount.total;const levels={gold:'ü•á',silver:'ü•à',bronze:'ü•â'};icon.textContent=levels[STATE.discount.ref_level]||'';badge.classList.toggle('promo',!!STATE.discount.promo_code)}else{badge.style.display='none'}}
function openDiscountInfo(){const d=STATE.discount;const levels={none:'–ù–µ—Ç —É—Ä–æ–≤–Ω—è',bronze:'ü•â –ë—Ä–æ–Ω–∑–∞',silver:'ü•à –°–µ—Ä–µ–±—Ä–æ',gold:'ü•á –ó–æ–ª–æ—Ç–æ'};document.getElementById('discBody').innerHTML=`<div style="text-align:center;margin-bottom:24px"><div style="font-size:60px;font-weight:700;color:var(--green)">${d.total}%</div><div style="color:var(--hint)">–≤–∞—à–∞ –æ–±—â–∞—è —Å–∫–∏–¥–∫–∞</div></div><div class="disc-card"><div class="disc-row ${d.ref_level!=='none'?'active':''}"><span>üë• –£—Ä–æ–≤–µ–Ω—å</span><span class="val">${levels[d.ref_level]} (${d.ref_count} –¥—Ä—É–∑–µ–π)</span></div><div class="disc-row ${d.referral>0?'active':''}"><span>üë• –†–µ—Ñ–µ—Ä–∞–ª—å–Ω–∞—è</span><span class="val">${d.referral}%</span></div><div class="disc-row ${d.admin>0?'active':''}"><span>‚≠ê –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω–∞—è</span><span class="val">${d.admin}%</span></div><div class="disc-row ${d.review>0?'active':''}"><span>‚≠ê –ó–∞ –æ—Ç–∑—ã–≤—ã</span><span class="val">${d.review}%</span></div><div class="disc-row ${d.promo>0?'active':''}"><span>üéü –ü—Ä–æ–º–æ–∫–æ–¥ ${d.promo_code||''}</span><span class="val">${d.promo}%</span></div><div class="disc-row ${!d.first_order_used?'active':''}"><span>üéâ –ü–µ—Ä–≤—ã–π –∑–∞–∫–∞–∑</span><span class="val">${d.first_order_used?'–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞':'–î–æ—Å—Ç—É–ø–Ω–∞!'}</span></div></div><p style="text-align:center;color:var(--hint);font-size:13px;margin-top:20px">–ü—Ä–∏–≥–ª–∞—à–∞–π—Ç–µ –¥—Ä—É–∑–µ–π –∏ –ø–æ–ª—É—á–∞–π—Ç–µ —Å–∫–∏–¥–∫–∏!<br>–ü—Ä–æ–º–æ–∫–æ–¥—ã –º–æ–∂–Ω–æ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –≤ –∫–æ—Ä–∑–∏–Ω–µ.</p>`;document.getElementById('discModal').classList.add('active');haptic('light')}
function closeDiscountInfo(){document.getElementById('discModal').classList.remove('active')}
function toggleTheme(){document.body.classList.toggle('light');localStorage.setItem('theme',document.body.classList.contains('light')?'light':'dark');haptic('light')}
function haptic(type){if(tg?.HapticFeedback)tg.HapticFeedback.impactOccurred(type)}
function toast(message){const el=document.createElement('div');el.className='toast';el.innerHTML=`<span class="toast-icon">${message.charAt(0)}</span><span>${message.slice(2)}</span>`;document.body.appendChild(el);setTimeout(()=>el.remove(),2500)}
function confettiEffect(){const colors=['#ff6b6b','#4ade80','#667eea','#f59e0b','#ec4899','#3b82f6'];for(let i=0;i<50;i++){const el=document.createElement('div');el.className='confetti';el.style.left=Math.random()*100+'vw';el.style.background=colors[Math.floor(Math.random()*colors.length)];el.style.animationDuration=(Math.random()*2+2)+'s';el.style.animationDelay=Math.random()*0.5+'s';document.body.appendChild(el);setTimeout(()=>el.remove(),4000)}}
function debounce(fn,delay){let timer;return function(...args){clearTimeout(timer);timer=setTimeout(()=>fn.apply(this,args),delay)}}
document.addEventListener('DOMContentLoaded',init);
</script>
</body>
</html>

